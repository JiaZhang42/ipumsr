<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geographic Data in `ipumsr` • ipumsr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Geographic Data in `ipumsr`">
<meta property="og:description" content="ipumsr">
<meta property="og:image" content="http://tech.popdata.org/ipumsr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ipumsr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ipums.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ipums.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/value-labels.html">Value labels</a>
    </li>
    <li>
      <a href="../articles/ipums-geography.html">Geographic data in ipumsr</a>
    </li>
    <li>
      <a href="../articles/ipums-bigdata.html">Big IPUMS data</a>
    </li>
    <li>
      <a href="../articles/ipums-api.html">IPUMS data extract API</a>
    </li>
    <li class="divider">
    </li>
<li>
      <a href="../articles/ipums-cps.html">CPS exercise</a>
    </li>
    <li>
      <a href="../articles/ipums-nhgis.html">NHGIS exercise</a>
    </li>
    <li>
      <a href="../articles/ipums-terra.html">IPUMS Terra exercise</a>
    </li>
    <li>
      <a href="https://ipums.org/exercises.shtml" class="external-link">More project exercises</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ipums/ipumsr" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://forum.ipums.org" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
<li>
  <a href="https://www.ipums.org/" class="external-link">
    <span class="fa fa-globe"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Geographic Data in <code>ipumsr</code>
</h1>
                        <h4 data-toc-skip class="author">Minnesota
Population Center</h4>
            
            <h4 data-toc-skip class="date">2022-06-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ipums/ipumsr/blob/HEAD/vignettes/ipums-geography.Rmd" class="external-link"><code>vignettes/ipums-geography.Rmd</code></a></small>
      <div class="hidden name"><code>ipums-geography.Rmd</code></div>

    </div>

    
    
<p>A lesser-known part of the IPUMS data catalog is our geographic
boundary files. For many projects, our geographers have created shape
files to complement the micro- and tabular data we provide. These
boundaries are stored in shape files, which can be downloaded from our
website (in slightly different places depending on the project):</p>
<ul>
<li>Microdata projects like <a href="https://www.idhsdata.org/idhs/gis.shtml" class="external-link">IPUMS DHS</a>, <a href="https://international.ipums.org/international/geography_gis.shtml" class="external-link">IPUMS
International</a> and <a href="https://usa.ipums.org/usa/volii/tgeotools.shtml" class="external-link">IPUMS USA</a>
provide shape files on dedicated geography pages that are separate from
the microdata extract system.</li>
<li>
<a href="https://www.nhgis.org" class="external-link">IPUMS NHGIS</a> provides access to
the shape files relevant to your current extract as part of the system
to create the data extract. The shape files are a separate download, but
are on the same page as the data.</li>
<li>
<a href="https://www.terrapop.org/" class="external-link">IPUMS Terra</a> provides shape
files inside the extract bundle and allows for aggregating microdata and
raster data into the boundaries. For more about using the geographic
data in IPUMS Terra, see the Terra vignette (using command
<code><a href="../articles/ipums-terra.html">vignette("ipums-terra", package = "ipumsr")</a></code>)</li>
</ul>
<p>This vignette offers an introduction to the types of geographies
available through IPUMS, then uses example data to walk through two
typical workflows for using boundary data with (1) IPUMS DHS, IPUMS
International or IPUMS USA, and (2) IPUMS NHGIS. The vignette focuses on
the specifics of working with IPUMS geographic data, and is by no means
an overview of working with geographic data in R. In the examples, I
show how to make static graphs using ggplot2, but there are many other R
packages to help you do all sorts of things with geographic data,
including making interactive maps and performing geospatial analysis. <a href="#resources">At the end of this vignette</a>, there are some
resources for learning more.</p>
<div class="section level2">
<h2 id="introduction-to-ipums-geographies">Introduction to IPUMS Geographies<a class="anchor" aria-label="anchor" href="#introduction-to-ipums-geographies"></a>
</h2>
<p>IPUMS geographic data can be classified along two dimensions:</p>
<div class="section level3">
<h3 id="harmonized-vs--non-harmonized">Harmonized vs. Non-Harmonized<a class="anchor" aria-label="anchor" href="#harmonized-vs--non-harmonized"></a>
</h3>
<p>Changing boundaries complicate longitudinal analyses of geographic
units. For many geographies IPUMS provides boundary files that have been
made consistent by combining geographies that share area for different
time periods (see the project specific geography webpages for more
details). IPUMS geography pages refer to these as “harmonized”,
“integrated” or “consistent”. Boundaries that have not been made
consistent over time are often referred to as “year-specific,” or may
simply be labelled with the year to which they pertain (eg “2010 PUMAs”
for IPUMS USA).</p>
</div>
<div class="section level3">
<h3 id="geographic-level">Geographic level<a class="anchor" aria-label="anchor" href="#geographic-level"></a>
</h3>
<p>The specificity of the geography (eg states and counties in the
United States). IPUMS often provides multiple levels of data, sometimes
overlapping (as the case of counties within states) but sometimes not
(eg zip codes in the US may not fit within county boundaries).</p>
</div>
</div>
<div class="section level2">
<h2 id="a-note-on-rs-geospatial-packages-sf-vs-sp">A Note on R’s Geospatial Packages: <code>sf</code> vs
<code>sp</code><a class="anchor" aria-label="anchor" href="#a-note-on-rs-geospatial-packages-sf-vs-sp"></a>
</h2>
<p>The <code>ipumsr</code> package allows for loading geospatial data in
two formats (sf for Simple Features and sp for Spatial). The
<code>sf</code> package is relatively new, and so does not have as
widespread support as the <code>sp</code> package. However, (in my
opinion) it does allow for easier analysis, and so may be a better place
to start if you have not used GIS data in R before.</p>
<p>All examples in this vignette will use the sf package, but sp’s
functionality is generally similar. The only place where the code is
noticeably different is for making plots. See the <a href="#resources">resources at the end of this vignette</a> for some
instructions on plotting with the sp package.</p>
</div>
<div class="section level2">
<h2 id="basic-workflow-for-microdata-projects-ipums-dhs-ipums-international-and-ipums-usa">Basic workflow for microdata projects (IPUMS DHS, IPUMS
International, and IPUMS USA)<a class="anchor" aria-label="anchor" href="#basic-workflow-for-microdata-projects-ipums-dhs-ipums-international-and-ipums-usa"></a>
</h2>
<p>Every analysis will be slightly different, but in general the
workflow for integrating geographic data and microdata from IPUMS DHS,
IPUMS International or IPUMS USA can be divided into four steps before
we’re ready to analyze the data:</p>
<ol style="list-style-type: decimal">
<li>Download microdata and shape files</li>
<li>Load microdata and shape files into R</li>
<li>Transform data</li>
<li>Merge microdata and boundary data</li>
</ol>
<p>In this vignette, I will first walk through these steps for an
example that maps geographic variation in the use of solid fuel for
cooking in households with children aged 0-5 in Colombia. Later on in
the vignette, I show a more <a href="#complicated">complicated
example</a> that combines the data for Colombia, Ecuador and Peru.</p>
<p>The data for this example is included in the package
<code>ipumsexamples</code>, which is available on github. If you want to
run the code from this vignette you will need to install it by running
the following commands:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">devtools</span><span class="op">)</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"ipums/ipumsr/ipumsexamples"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This function helps find the data from the ipumsexamples package for us</span>
<span class="va">ex_file</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="va">x</span>, package <span class="op">=</span> <span class="st">"ipumsexamples"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Before you work on the data for yourself, I recommend reading the
specifics about the project’s geographic data on the IPUMS website (<a href="https://www.idhsdata.org/idhs/gis.shtml" class="external-link">IPUMS DHS</a> <a href="https://international.ipums.org/international/geography_gis.shtml" class="external-link">IPUMS
International</a> and <a href="https://usa.ipums.org/usa/volii/tgeotools.shtml" class="external-link">IPUMS USA</a>).
Each project has its own idiosyncrasies that you’ll want to understand
before diving in.</p>
<div class="section level3">
<h3 id="download-microdata-and-shape-files">1) Download microdata and shape files<a class="anchor" aria-label="anchor" href="#download-microdata-and-shape-files"></a>
</h3>
<p>From the data extract engine I see that the variable FUELCOOK is
available in three censuses from Colombia (1985, 1993 and 2005).</p>
<p>The decision to use harmonized or year-specific geographic variables
depends on how you want to analyze change over time. If I want to be
able to compare how the data has changed over time for particular
geographies, I need to use the harmonized version of the Colombian
geography so that the geographic units are the same. In this case, I
will use the harmonized version, but other analyses could use the
non-harmonized versions (like if I cared about showing the most
up-to-date boundaries more than being able to compare across years).
Similarly, the level of the geographic variables you choose depends on
your research question. For this example I will use level 1
geography.</p>
<p>Once I know which geographic variables I want, I need to add those
geographic variables to my microdata extract <em>and</em> download the
corresponding shape files from the project specific geography page.</p>
<p>In the IPUMS International microdata extract system, I added the
variable GEOLEV1 (which contains harmonized first-level geography) for
Colombia. To download shape files on the <a href="https://international.ipums.org/international/geography_gis.shtml" class="external-link">IPUMS
International geography page</a>, I can click on the “GIS Boundary Files
Download” link. For Colombia, I’ll want to look on the “Spatially
harmonized first-level geography” page.</p>
</div>
<div class="section level3">
<h3 id="load-microdata-and-shape-files-into-r">2) Load microdata and shape files into R<a class="anchor" aria-label="anchor" href="#load-microdata-and-shape-files-into-r"></a>
</h3>
<p>The <code><a href="../reference/read_ipums_micro.html">read_ipums_micro()</a></code> function loads the data and the
<code><a href="../reference/read_ipums_sf.html">read_ipums_sf()</a></code> (or <code><a href="../reference/read_ipums_sf.html">read_ipums_sp()</a></code>) function
loads the shape files.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.ipums.org" class="external-link">ipumsr</a></span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Load data</span>
<span class="va">ipumsi_ddi_file</span> <span class="op">&lt;-</span> <span class="fu">ex_file</span><span class="op">(</span><span class="st">"ipumsi_00011.xml"</span><span class="op">)</span>
<span class="va">ipumsi_ddi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_ddi.html">read_ipums_ddi</a></span><span class="op">(</span><span class="va">ipumsi_ddi_file</span><span class="op">)</span>
<span class="va">ipumsi_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_micro.html">read_ipums_micro</a></span><span class="op">(</span><span class="va">ipumsi_ddi_file</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># Note this data contains data from Ecuador and Peru for use later on</span>
<span class="co"># in the vignette. For now we will just filter it out of our data</span>
<span class="va">ipumsi_data</span> <span class="op">&lt;-</span> <span class="va">ipumsi_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">COUNTRY</span> <span class="op">==</span> <span class="fl">170</span><span class="op">)</span> <span class="co"># Labelled value 170 is Colombia</span>

<span class="co"># Load shape file</span>
<span class="va">colombia_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_sf.html">read_ipums_sf</a></span><span class="op">(</span><span class="fu">ex_file</span><span class="op">(</span><span class="st">"geo1_co1964_2005.zip"</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="transform-data">3) Transform data<a class="anchor" aria-label="anchor" href="#transform-data"></a>
</h3>
<p>Our first data transformation is a step that most analyses will need
regardless of whether they use geographic data or not. Though IPUMS
microdata has been cleaned and formatted to be easy to use, generally
there is at least some data processing we need to do (as discussed in
the value-labels vignette).</p>
<p>In this example, I want to make the solid fuel use variable binary
and also use the value labels for COUNTRY, SAMPLE and AGE2, but zap them
for the geography variables.</p>
<p>When combining with shape files, the shape files also generally have
the labels for the geographic units, so we do not need to keep the
labels on the geographic variables in the microdata. Also, because the
name of a geography may not be unique (eg there are 8 states in the US
with a Fulton County), it’s better to merge on the unique numeric
code.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Convert labelled values to factors where useful (and zap elsewhere)</span>
<span class="co"># See the value-labels vignette for more on this process.</span>
<span class="va">fuel_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ipums_var_info.html">ipums_val_labels</a></span><span class="op">(</span><span class="va">ipumsi_data</span><span class="op">$</span><span class="va">FUELCOOK</span><span class="op">)</span>
<span class="va">fuel_missing_lbls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  <span class="st">"NIU (not in universe)"</span>, <span class="st">"Multiple fuels"</span>, <span class="st">"Other combinations"</span>, <span class="st">"Other"</span>, <span class="st">"Unknown/missing"</span>
<span class="op">)</span>
<span class="va">fuel_solid_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span><span class="op">:</span><span class="fl">56</span>, <span class="fl">61</span>, <span class="fl">73</span>, <span class="fl">74</span>, <span class="fl">75</span><span class="op">)</span>

<span class="va">ipumsi_data</span> <span class="op">&lt;-</span> <span class="va">ipumsi_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">COUNTRY</span>, <span class="va">SAMPLE</span>, <span class="va">AGE2</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="fu"><a href="../reference/lbl_clean.html">lbl_clean</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="co"># We will get labels from shape file for geographic variables</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"GEO"</span><span class="op">)</span><span class="op">)</span>, <span class="va">zap_labels</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    SOLIDFUEL <span class="op">=</span> <span class="va">FUELCOOK</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
      <span class="fu"><a href="../reference/lbl_na_if.html">lbl_na_if</a></span><span class="op">(</span><span class="op">~</span><span class="va">.lbl</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">fuel_missing_lbls</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
      <span class="fu"><a href="../reference/lbl_relabel.html">lbl_relabel</a></span><span class="op">(</span>
        <span class="fu"><a href="../reference/lbl.html">lbl</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"Non-solid Fuel"</span><span class="op">)</span> <span class="op">~</span> <span class="op">!</span><span class="va">.val</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">fuel_solid_vals</span>,
        <span class="fu"><a href="../reference/lbl.html">lbl</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"Solid Fuel"</span><span class="op">)</span> <span class="op">~</span> <span class="va">.val</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">fuel_solid_vals</span>
      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
      <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="op">)</span>,
    FUELCOOK <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="va">FUELCOOK</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>The next data transformation will be to summarize the microdata to
the geographic unit. Microdata has one observation per person, but
usually when we are making a map, we want a summary measure for a
geographic unit. In this case, because we have data at three time points
for Colombia, we summarize by geographic unit and year.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ipumsi_summary</span> <span class="op">&lt;-</span> <span class="va">ipumsi_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">YEAR</span>, <span class="va">COUNTRY</span>, <span class="va">GEOLEV1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>
    pct_solid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">SOLIDFUEL</span> <span class="op">==</span> <span class="st">"Solid Fuel"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    .groups <span class="op">=</span> <span class="st">"drop"</span>
  <span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="merge-microdata-and-boundary-data">4) Merge microdata and boundary data<a class="anchor" aria-label="anchor" href="#merge-microdata-and-boundary-data"></a>
</h3>
<p>The function <code><a href="../reference/ipums_shape_left_join.html">ipums_shape_inner_join()</a></code> allows us to
combine the data and shape file while smoothing out some of the
complications because the data and shape files are provided in slightly
different formats (eg, the geography ID variable is numeric in the
microdata, but stored as character in the shape file). It also gives a
message when some of the data has been dropped by the join (though in
this example there are no mismatches - see the <a href="#complicated">complicated example</a> below for an example where
this does happen).</p>
<p>Before we are able to join the data, we need to determine what the
geographic ID is called in each file. Unfortunately, for microdata
projects, the name of the variable is often different between the two.
The project’s website often has information explaining how they are
named, but they may not always describe the exact abbreviations. In this
example, in the data it is called “GEOLEV1” and in the shape file it is
“GEOLEVEL1”.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ipumsi_summary</span><span class="op">)</span>
<span class="co">#&gt; [1] "YEAR"      "COUNTRY"   "GEOLEV1"   "pct_solid"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">colombia_shape</span><span class="op">)</span>
<span class="co">#&gt; [1] "CNTRY_NAME" "ADMIN_NAME" "CNTRY_CODE" "GEOLEVEL1"  "PARENT"    </span>
<span class="co">#&gt; [6] "geometry"</span>

<span class="va">ipumsi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ipums_shape_left_join.html">ipums_shape_inner_join</a></span><span class="op">(</span>
  <span class="va">ipumsi_summary</span>, 
  <span class="va">colombia_shape</span>,
  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GEOLEV1"</span> <span class="op">=</span> <span class="st">"GEOLEVEL1"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ready-to-analyze-data">Ready to analyze data!<a class="anchor" aria-label="anchor" href="#ready-to-analyze-data"></a>
</h3>
<p>Now the data is ready for us to use. Here’s a quick example of how to
make a map with ggplot2.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ipumsi</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">pct_solid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">YEAR</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">""</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"% of Children 0-5 Who Live in a Home That Cooks Using Solid Fuel"</span>,
    subtitle <span class="op">=</span> <span class="st">"Colombia (1985, 1993, 2005) Census Data"</span>,
    caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Source: "</span>, <span class="fu"><a href="../reference/ipums_file_info.html">ipums_file_info</a></span><span class="op">(</span><span class="va">ipumsi_ddi</span>, <span class="st">"ipums_project"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p><img src="ipums-geography_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="basic-workflow-for-ipums-nhgis">Basic workflow for IPUMS NHGIS<a class="anchor" aria-label="anchor" href="#basic-workflow-for-ipums-nhgis"></a>
</h2>
<p>The geographic data is more tightly integrated with the census data
for the IPUMS NHGIS project, but otherwise the process for using IPUMS
NHGIS data is similar to using the microdata projects.</p>
<p>Again, the specifics of each analysis will be slightly different, but
here is an example showing the median age by census block in Connecticut
and Rhode Island.</p>
<div class="section level3">
<h3 id="download-data-and-shape-files">1) Download data and shape files<a class="anchor" aria-label="anchor" href="#download-data-and-shape-files"></a>
</h3>
<p>The IPUMS NHGIS extract engine has better integration of the shape
files and data. The website allows you to filter on variables that are
only available at a particular geographic level when looking for
variables and to select particular levels after selecting a table. Also,
the geographic boundary files can be selected alongside the tables using
the “GIS Boundary Files” tab. The extract engine also provides a single
place to download both the data and the boundary files.</p>
<p>In our example, we select table P13, “Median Age by Sex” at the
census block level. Because census block data is so large, the extract
engine divides each state’s boundaries into different files, so we also
need to select that we want Connecticut and Rhode Island.</p>
</div>
<div class="section level3">
<h3 id="load-data-and-shape-files-into-r">2) Load data and shape files into R<a class="anchor" aria-label="anchor" href="#load-data-and-shape-files-into-r"></a>
</h3>
<p>For most uses you will be able to load the data and shape files at
the same time using the <code><a href="../reference/read_nhgis.html">read_nhgis_sf()</a></code> (or
<code><a href="../reference/read_nhgis.html">read_nhgis_sp()</a></code>) function. Even when the geographic data is
divided by the extract engine because of size reasons (like how each
census block file is for a single state), these functions will combine
the shape files for us. However, if your analysis combines across years
or geographic levels, you will need to load the data separately and then
combine.</p>
<p>So in our example, we run the following to load the data:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nhgis_ddi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_codebook.html">read_ipums_codebook</a></span><span class="op">(</span><span class="fu">ex_file</span><span class="op">(</span><span class="st">"nhgis0706_csv.zip"</span><span class="op">)</span><span class="op">)</span> 
<span class="va">nhgis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_nhgis.html">read_nhgis_sf</a></span><span class="op">(</span>
  data_file <span class="op">=</span> <span class="fu">ex_file</span><span class="op">(</span><span class="st">"nhgis0706_csv.zip"</span><span class="op">)</span>,
  shape_file <span class="op">=</span> <span class="fu">ex_file</span><span class="op">(</span><span class="st">"nhgis0706_shape_small.zip"</span><span class="op">)</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="co">#&gt; Warning: `as.tibble()` was deprecated in tibble 2.0.0.</span>
<span class="co">#&gt; Please use `as_tibble()` instead.</span>
<span class="co">#&gt; The signature and semantics have changed, see `?as_tibble`.</span>
<span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span>
<span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</span></span></code></pre></div>
<p>In other situations, such as combining data from different tables or
geographic level, you may need to load the data and shape files
separately. In this case, you can use the function
<code><a href="../reference/read_nhgis.html">read_nhgis()</a></code> to load the data and
<code><a href="../reference/read_ipums_sf.html">read_ipums_sf()</a></code> (or sp) to load the shape files. In these
analyses, the process for combining the data is similar to the process
described below for the more complicated <a href="#complicated">IPUMS
International workflow</a> where multiple shape files are combined.</p>
</div>
<div class="section level3">
<h3 id="ready-to-analyze-data-1">Ready to analyze data!<a class="anchor" aria-label="anchor" href="#ready-to-analyze-data-1"></a>
</h3>
<p>Now we’re ready to use the data. Here is a map of the median age for
Hartford County, CT and Providence County, RI.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># The median age is 0 for unpopulated counties, set them to NA</span>
<span class="va">nhgis</span> <span class="op">&lt;-</span> <span class="va">nhgis</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>H77001 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">H77001</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">H77001</span><span class="op">)</span><span class="op">)</span>

<span class="co"># For map filter to Hartford County, CT and Providence County, RI</span>
<span class="va">nhgis_subset</span> <span class="op">&lt;-</span> <span class="va">nhgis</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">COUNTY</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Hartford County"</span>, <span class="st">"Providence County"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>place_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">COUNTY</span>, <span class="st">", "</span>, <span class="va">STATE</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nhgis_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">H77001</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"blank"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">place_name</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Median Age of Population By Census Block"</span>,
    subtitle <span class="op">=</span> <span class="st">"2010 Census"</span>,
    caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span>
      <span class="st">"Source: "</span>, <span class="fu"><a href="../reference/ipums_file_info.html">ipums_file_info</a></span><span class="op">(</span><span class="va">nhgis_ddi</span>, <span class="st">"ipums_project"</span><span class="op">)</span>, <span class="st">"\n"</span>,
      <span class="st">"Simplified Census Block boundaries (1% of points retained)"</span>
    <span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p><img src="ipums-geography_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="complicated">Combining multiple shape files<a class="anchor" aria-label="anchor" href="#complicated"></a>
</h2>
<p>When combining multiple shape files, the process is generally
similar, but it does require some more steps in the “Transform Data”
step. To demonstrate, I will continue the IPUMS International example
from above, but add the data from Ecuador and Peru.</p>
<p>In this example, I have added the Ecuador 2010 and Peru 2007
censuses, to the IPUMS international example above. These samples also
have data for the FUELCOOK variable. Rather than use the harmonized
geography, for these countries I chose to use the non-harmonized data
for these 2 countries. Because the FUELCOOK variable is only available
in one census for these countries, the benefits of the harmonized
version are less important (but once again, this decision depends on the
analysis).</p>
<p>I made sure to include the year-specific variables GEO1_EC2010 and
GEO1_PE2007 for Ecuador and Peru in the microdata extract, and got the
geographic boundary files from the “Year-specific first-level geography”
page.</p>
<p>Now I’m ready to load the data into R as before. The only changes are
that I no longer filter out the non-Colombian data and load the extra
shape files. Then I transform the value labels just as I did when
working with Colombia.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load data</span>
<span class="va">ipumsi_ddi_file</span> <span class="op">&lt;-</span> <span class="fu">ex_file</span><span class="op">(</span><span class="st">"ipumsi_00011.xml"</span><span class="op">)</span>
<span class="va">ipumsi_ddi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_ddi.html">read_ipums_ddi</a></span><span class="op">(</span><span class="va">ipumsi_ddi_file</span><span class="op">)</span>
<span class="va">ipumsi_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_micro.html">read_ipums_micro</a></span><span class="op">(</span><span class="va">ipumsi_ddi_file</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># Load shape files</span>
<span class="va">colombia_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_sf.html">read_ipums_sf</a></span><span class="op">(</span><span class="fu">ex_file</span><span class="op">(</span><span class="st">"geo1_co1964_2005.zip"</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">ecuador_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_sf.html">read_ipums_sf</a></span><span class="op">(</span><span class="fu">ex_file</span><span class="op">(</span><span class="st">"geo1_ec2010.zip"</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">peru_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_sf.html">read_ipums_sf</a></span><span class="op">(</span><span class="fu">ex_file</span><span class="op">(</span><span class="st">"geo1_pe2007.zip"</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># Convert labelled values to factors where useful (and zap elsewhere)</span>
<span class="co"># See the value-labels vignette for more on this process.</span>
<span class="va">fuel_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ipums_var_info.html">ipums_val_labels</a></span><span class="op">(</span><span class="va">ipumsi_data</span><span class="op">$</span><span class="va">FUELCOOK</span><span class="op">)</span>
<span class="va">fuel_missing_lbls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  <span class="st">"NIU (not in universe)"</span>, <span class="st">"Multiple fuels"</span>, <span class="st">"Other combinations"</span>, <span class="st">"Other"</span>, <span class="st">"Unknown/missing"</span>
<span class="op">)</span>
<span class="va">fuel_solid_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span><span class="op">:</span><span class="fl">56</span>, <span class="fl">61</span>, <span class="fl">73</span>, <span class="fl">74</span>, <span class="fl">75</span><span class="op">)</span>

<span class="va">ipumsi_data</span> <span class="op">&lt;-</span> <span class="va">ipumsi_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">COUNTRY</span>, <span class="va">SAMPLE</span>, <span class="va">AGE2</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="fu"><a href="../reference/lbl_clean.html">lbl_clean</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="co"># We will get labels from shape file for geographic variables</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"GEO"</span><span class="op">)</span><span class="op">)</span>, <span class="va">zap_labels</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    SOLIDFUEL <span class="op">=</span> <span class="va">FUELCOOK</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
      <span class="fu"><a href="../reference/lbl_na_if.html">lbl_na_if</a></span><span class="op">(</span><span class="op">~</span><span class="va">.lbl</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">fuel_missing_lbls</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
      <span class="fu"><a href="../reference/lbl_relabel.html">lbl_relabel</a></span><span class="op">(</span>
        <span class="fu"><a href="../reference/lbl.html">lbl</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"Non-solid Fuel"</span><span class="op">)</span> <span class="op">~</span> <span class="op">!</span><span class="va">.val</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">fuel_solid_vals</span>,
        <span class="fu"><a href="../reference/lbl.html">lbl</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"Solid Fuel"</span><span class="op">)</span> <span class="op">~</span> <span class="va">.val</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">fuel_solid_vals</span>
      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
      <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="op">)</span>,
    FUELCOOK <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="va">FUELCOOK</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>Now that we are combining geographies we need to combine the
geographic ID variables in the data (GEOLEV1 for Colombia, GEO1_EC2010
for Ecuador and GEO_PE2007 for Peru) into a single variable.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ipumsi_data</span> <span class="op">&lt;-</span> <span class="va">ipumsi_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>GEOLEV1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span>
    <span class="va">COUNTRY</span> <span class="op">==</span> <span class="st">"Colombia"</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">GEOLEV1</span><span class="op">)</span>,
    <span class="va">COUNTRY</span> <span class="op">==</span> <span class="st">"Ecuador"</span> <span class="op">~</span> <span class="va">GEO1_EC2010</span>,
    <span class="va">COUNTRY</span> <span class="op">==</span> <span class="st">"Peru"</span> <span class="op">~</span> <span class="va">GEO1_PE2007</span>
  <span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Then we can summarize to the geographic units and year as before:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ipumsi_summary</span> <span class="op">&lt;-</span> <span class="va">ipumsi_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">YEAR</span>, <span class="va">COUNTRY</span>, <span class="va">GEOLEV1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>
    pct_solid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">SOLIDFUEL</span> <span class="op">==</span> <span class="st">"Solid Fuel"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    .groups <span class="op">=</span> <span class="st">"drop"</span>
  <span class="op">)</span></code></pre></div>
<p>Another new step when combining multiple geographies is to bind the
shape files together. The command <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind()</a></code> has been
implemented for sf (and sp) spatial objects, but before we do that, we
want to give each country’s shape data the same structure. When
combining non-harmonized geographies or across different geographic
levels, the variable names will not be the same. There is some guidance
on the IPUMS website about how the variables are named, but some of it
will require looking at your shape files.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Currently each shape file has different variable names</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">colombia_shape</span><span class="op">)</span>
<span class="co">#&gt; [1] "CNTRY_NAME" "ADMIN_NAME" "CNTRY_CODE" "GEOLEVEL1"  "PARENT"    </span>
<span class="co">#&gt; [6] "geometry"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ecuador_shape</span><span class="op">)</span>
<span class="co">#&gt; [1] "CNTRY_NAME" "ADMIN_NAME" "CNTRY_CODE" "IPUM2010"   "PROV2010"  </span>
<span class="co">#&gt; [6] "PARENT"     "geometry"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">peru_shape</span><span class="op">)</span>
<span class="co">#&gt; [1] "CNTRY_NAME" "ADMIN_NAME" "CNTRY_CODE" "IPUM2007"   "DEPT2007"  </span>
<span class="co">#&gt; [6] "PARENT"     "geometry"</span>

<span class="co"># Keep CNTRY_NAME (because the year-specific geography codes are not unique across</span>
<span class="co"># countries, so we need to merge using it), ADMIN_NAME (to get the name of </span>
<span class="co"># geography), rename GEOLEVEL1, IPUM2010 and IPUM2007 to the same variable</span>
<span class="co"># name, and keep geography, which contains the shape)</span>
<span class="va">colombia_shape</span> <span class="op">&lt;-</span> <span class="va">colombia_shape</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">CNTRY_NAME</span>, <span class="va">ADMIN_NAME</span>, GEOJOIN <span class="op">=</span> <span class="va">GEOLEVEL1</span><span class="op">)</span>
<span class="va">ecuador_shape</span> <span class="op">&lt;-</span> <span class="va">ecuador_shape</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">CNTRY_NAME</span>, <span class="va">ADMIN_NAME</span>, GEOJOIN <span class="op">=</span> <span class="va">IPUM2010</span><span class="op">)</span>
<span class="va">peru_shape</span> <span class="op">&lt;-</span> <span class="va">peru_shape</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">CNTRY_NAME</span>, <span class="va">ADMIN_NAME</span>, GEOJOIN <span class="op">=</span> <span class="va">IPUM2007</span><span class="op">)</span>

<span class="co"># Now we can rbind them together</span>
<span class="va">all_shapes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">colombia_shape</span>, <span class="va">ecuador_shape</span>, <span class="va">peru_shape</span><span class="op">)</span></code></pre></div>
<p>Then we can join the data in a similar process as before. Since we
named the geography ID variables in the shape file GEOJOIN, we use that
in the <code>by</code> parameter. Also, because the non-harmonized
geography IDs are not unique across countries, we use the country’s name
to join as well.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ipumsi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ipums_shape_left_join.html">ipums_shape_inner_join</a></span><span class="op">(</span>
  <span class="va">ipumsi_summary</span>, 
  <span class="va">all_shapes</span>,
  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"COUNTRY"</span> <span class="op">=</span> <span class="st">"CNTRY_NAME"</span>, <span class="st">"GEOLEV1"</span> <span class="op">=</span> <span class="st">"GEOJOIN"</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; Some observations were lost in the join (1 observations in the shape file). See</span>
<span class="co">#&gt; `join_failures(...)` for more details.</span></code></pre></div>
<p>Notice that the join warned us about one observation dropping out of
the shape file. Because we chose an inner join, all observations that
were not in both the microdata and the shape data are dropped from the
results. Join failures like this can happen for a variety of
reasons.</p>
<p>We can investigate this join failure using the
<code>join_failures</code> command.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/join_failures.html">join_failures</a></span><span class="op">(</span><span class="va">ipumsi</span><span class="op">)</span>
<span class="co">#&gt; $shape</span>
<span class="co">#&gt; Simple feature collection with 1 feature and 3 fields</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -70.03649 ymin: -16.3001 xmax: -69.09491 ymax: -15.23293</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span>
<span class="co">#&gt;   COUNTRY ADMIN_NAME    GEOLEV1                                         geometry</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>                               <span style="color: #949494; font-style: italic;">&lt;MULTIPOLYGON [°]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Peru    Lake Titicaca     888 (((-69.70387 -15.23504, -69.70337 -15.23512, -6…</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $data</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 0 × 4</span></span>
<span class="co">#&gt; <span style="color: #949494;"># … with 4 variables: YEAR &lt;int&gt;, COUNTRY &lt;chr&gt;, GEOLEV1 &lt;int&gt;, pct_solid &lt;dbl&gt;</span></span></code></pre></div>
<p>In this case, it appears that the shape file includes Lake Titicaca
for mapping purposes, even though no one lives in the lake. We will just
leave this boundary out of our dataset.</p>
<p>In general, these kinds of join failures can sometimes indicate that
something is wrong with your data. Perhaps: - The wrong shape file was
used - The data was not completely loaded - The wrong ID variable was
used in the <code>by</code> parameter</p>
<p>But others may not be relevant to your analysis: - There is no
population inside of a geography and so it exists in the shape file but
not the data (as happened in this case) - A geography was listed in the
census, but it’s boundaries are so small that they were not put in the
shape file (can happen when shape files are simplified so that they
don’t take as much computer resources) - A geography doesn’t actually
refer to a place with real boundaries. This happens in some US censuses
which have census blocks that refer to “Crews of Vessels” for crews of
naval ships. Since ships don’t have a fixed location, they are not
included in the boundary file.</p>
<p>After confirming that join was successful, we can make the map with
all 3 countries:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Convert the year to a round variable to display in facets</span>
<span class="va">ipumsi</span> <span class="op">&lt;-</span> <span class="va">ipumsi</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>census_round <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">YEAR</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1984</span>, <span class="fl">1992</span>, <span class="fl">2004</span>, <span class="fl">2014</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1985"</span>, <span class="st">"1993"</span>, <span class="st">"2005-2010"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ipumsi</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">pct_solid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">census_round</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">""</span>, labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"% of Children 0-5 Who Live in a Home That Cooks Using Solid Fuel"</span>,
    subtitle <span class="op">=</span> <span class="st">"Colombia, Ecuador and Peru Census Data"</span>,
    caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Source: "</span>, <span class="fu"><a href="../reference/ipums_file_info.html">ipums_file_info</a></span><span class="op">(</span><span class="va">ipumsi_ddi</span>, <span class="st">"ipums_project"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p><img src="ipums-geography_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="resources">Resources for Geographic Analysis in R<a class="anchor" aria-label="anchor" href="#resources"></a>
</h2>
<p>There are so many great resources on working with geographic data in
R, it’s hard to pick just a few. Here are a few places to start:</p>
<ul>
<li>The <a href="https://cran.r-project.org/view=Spatial" class="external-link">CRAN Task View
for Spatial Analysis</a> describes many of the packages available for
spatial analysis in R.</li>
<li>For general information about the sf and sp packages, I recommend
reading the vignettes for those
packages(<code>vignette(package = "sf")</code> and
<code>vignette(package = "sp")</code>).</li>
<li>The <a href="https://rstudio.github.io/leaflet/" class="external-link">leaflet</a> package
is great for interactive web-technology based maps.</li>
<li>The CRAN website has a great tutorial called <a href="https://cran.r-project.org/doc/contrib/intro-spatial-rl.pdf" class="external-link">“Introduction
to visualizing spatial Data in R”</a> that focuses on visualizing data
from the sp package.</li>
<li>The <a href="https://github.com/r-spatial/sf/blob/master/PROPOSAL.md" class="external-link">R
consortium proposal for the sf package</a> provides of the history
behind the sf package.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.ipums.org" class="external-link">IPUMS</a> at the University of Minnesota.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> .</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '4ffa912ace97d2493f6ed39f20e94316',
    indexName: 'ipumsr',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
