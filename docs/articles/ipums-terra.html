<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>`ipumsr` Example - Terra • ipumsr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="`ipumsr` Example - Terra">
<meta property="og:description" content="ipumsr">
<meta property="og:image" content="http://tech.popdata.org/ipumsr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ipumsr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ipums.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ipums.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/value-labels.html">Value labels</a>
    </li>
    <li>
      <a href="../articles/ipums-geography.html">Geographic data in ipumsr</a>
    </li>
    <li>
      <a href="../articles/ipums-bigdata.html">Big IPUMS data</a>
    </li>
    <li class="divider">
    <li>
      <a href="../articles/ipums-cps.html">CPS exercise</a>
    </li>
    <li>
      <a href="../articles/ipums-nhgis.html">NHGIS exercise</a>
    </li>
    <li>
      <a href="../articles/ipums-terra.html">IPUMS Terra exercise</a>
    </li>
    <li>
      <a href="https://ipums.org/exercises.shtml">More project exercises</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mnpopcenter/ipumsr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://forum.ipums.org">
    <span class="fa fa-users"></span>
     
  </a>
</li>
<li>
  <a href="https://www.ipums.org/">
    <span class="fa fa-globe"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>
<code>ipumsr</code> Example - Terra</h1>
                        <h4 class="author">Minnesota Population Center</h4>
            
            <h4 class="date">2020-06-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mnpopcenter/ipumsr/blob/master/vignettes/ipums-terra.Rmd"><code>vignettes/ipums-terra.Rmd</code></a></small>
      <div class="hidden name"><code>ipums-terra.Rmd</code></div>

    </div>

    
    
<pre><code>#&gt; Could not find terra data and so could not run vignette.</code></pre>
<div id="ipums-terra-integrated-population-and-environment-data" class="section level1">
<h1 class="hasAnchor">
<a href="#ipums-terra-integrated-population-and-environment-data" class="anchor"></a>IPUMS Terra: Integrated Population and Environment Data</h1>
<p>The IPUMS Terra project allows you to create datasets for your research that seamlessly combine area-level data, raster data and microdata and use whichever of these data formats is best for your analysis.</p>
<p>Raster data is data that describes the world on a grid - each cell in the grid gets its own value. Temperature is an example of data available in raster form from IPUMS Terra - satellite imagery allows geographers to create estimates of average temperature for approximately 1 km square grids across the globe.</p>
<p>Area level data is data that represents a particular area. In IPUMS Terra, the areas are political boundaries, like countries, states or provinces.</p>
<p>Microdata is data that describe each person separately. In IPUMS Terra, this data generally comes from census data from the IPUMS International project.</p>
<p>Learn more about the kinds of data in IPUMS Terra here: <a href="https://data.terrapop.org" class="uri">https://data.terrapop.org</a></p>
<p><code>ipumsr</code> helps you read this data into R so you can continue your analysis.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ipumsr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">sf</span>)</pre></body></html></div>
</div>
<div id="learning-more-about-spatial-data-in-r" class="section level1">
<h1 class="hasAnchor">
<a href="#learning-more-about-spatial-data-in-r" class="anchor"></a>Learning more about spatial data in R</h1>
<p>This vignette focuses on the mechanics of getting spatial data from IPUMS Terra into R, but it glosses over the details about what you can do after you’ve loaded it. To learn more about these, here are some resources:</p>
<ul>
<li>
<strong><a href="http://rspatial.org/">http://rspatial.org/</a></strong> has a great set of tutorials and other documentation about spatial tools.</li>
<li>The <strong><a href="https://github.com/r-spatial/sf">sf package github page</a></strong> has links to documentation about the sf package, which is great for working with the area level files.</li>
<li>The <strong><a href="https://cran.r-project.org/view=Spatial">Spatial Task View on CRAN</a></strong> organizes the packages that provide tools for spatial analysis.</li>
</ul>
</div>
<div id="example-age-and-migration-patterns-by-temperature-in-the-us" class="section level1">
<h1 class="hasAnchor">
<a href="#example-age-and-migration-patterns-by-temperature-in-the-us" class="anchor"></a>Example: Age and migration patterns by temperature in the US</h1>
<p>On this cold February day in Minnesota, I wonder how migration between areas of the US is affected by the temperature and whether I see any evidence of my preconception that older people retire to warmer climates. As a quick aside - this analysis might be better served by data from the IPUMS NHGIS project (see <code>vigntette("ipums-nhgis")</code>), because it often has more granular geographic areas than IPUMS Terra, which which pulls from our microdata projects, but I use Terra to show off the way it helps moving between data types.</p>
<div id="raster-data" class="section level2">
<h2 class="hasAnchor">
<a href="#raster-data" class="anchor"></a>Raster data</h2>
<p>IPUMS Terra includes raster data on the average temperature 1950-2000 by month from the WorldClim dataset. It also converts area-level summaries of some variables from the US census microdata to raster grid, so we can get the total population and population by age on a grid. You can learn more about making extracts here: <a href="https://www.terrapop.org/sites/www.terrapop.org/files/raster_tutorial_jan2017_final.pdf">IPUMS Terra Raster Extract Guide</a>.</p>
<p>For the example in this vignette, I use the sample 2010 US Census and variables:</p>
<ul>
<li>Area Level: POPTOT, POP6569, POP7074, POP7579, POP80 (year-specific and at the lowest geographic level available)</li>
<li>Raster: TEMPAVGFEB (mean, also year-specific and at lowest geographic level available)</li>
</ul>
<p>Once we’ve made the extract and downloaded it, let’s check what’s available in it using the function <code><a href="../reference/ipums_list_files.html">ipums_list_files()</a></code>.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="../reference/ipums_list_files.html">ipums_list_files</a></span>(<span class="no">raster_extract</span>)</pre></body></html></div>
<p>To load the data, ipumsr provides two functions: <code><a href="../reference/read_terra_raster.html">read_terra_raster()</a></code> and <code><a href="../reference/read_terra_raster.html">read_terra_raster_list()</a></code>. The first reads a single raster, and the second loads 1 or more and puts them into a list.</p>
<div id="reading-a-single-raster" class="section level3">
<h3 class="hasAnchor">
<a href="#reading-a-single-raster" class="anchor"></a>Reading a single raster</h3>
<p>Let’s first look at loading a single layer, by making a map of the <code>TEMPAVGFEB</code> layer (called <code>TEMPAVGFEBUS2013.tiff</code> in the file, but we can refer to it with the <code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches()</a></code> function).</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">febtemp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/read_terra_raster.html">read_terra_raster</a></span>(<span class="no">raster_extract</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span>(<span class="st">"TEMPAVGFEB"</span>))</pre></body></html></div>
<p>The details of making good maps with raster data are beyond this tutorial, (see below for some pointers on where to learn more), but just to prove that we got the data, we can use the raster package’s built in <code><a href="https://rdrr.io/pkg/sf/man/plot.html">plot()</a></code> method.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># Crop map a bit</span>
<span class="no">zoomed_extent</span> <span class="kw">&lt;-</span> <span class="kw pkg">raster</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">180</span>, -<span class="fl">64</span>, <span class="fl">16.5</span>, <span class="fl">72.5</span>))

<span class="kw pkg">raster</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>(<span class="no">febtemp</span> / <span class="fl">10</span>, <span class="kw">ext</span> <span class="kw">=</span> <span class="no">zoomed_extent</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Average temp (deg C) in Feb\n1950-2010 (US raster)"</span>)</pre></body></html></div>
</div>
<div id="reading-multiple-rasters" class="section level3">
<h3 class="hasAnchor">
<a href="#reading-multiple-rasters" class="anchor"></a>Reading multiple rasters</h3>
<p>We can also read multiple rasters and put them into a list object.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">all_rasters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/read_terra_raster.html">read_terra_raster_list</a></span>(<span class="no">raster_extract</span>)</pre></body></html></div>
<p>Now we can make a map as before; this would be identical to the one above.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="kw pkg">raster</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>(<span class="no">all_rasters</span><span class="kw">[[</span><span class="st">"TEMPAVGFEBUS2013"</span>]] / <span class="fl">10</span>, <span class="kw">ext</span> <span class="kw">=</span> <span class="no">zoomed_extent</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Average temp (deg C) in Feb\n1950-2010 (US raster)"</span>)</pre></body></html></div>
<p>Again the details of spatial analysis of raster data in R are beyond the scope of this document (see below for some resources), but it one thing to keep in mind is that IPUMS Terra data, especially data from different sources (like rasterized area level data vs. the temperature data) may not have the same spatial extent (coverage area) or resolution, so you may need to do some conversion.</p>
<p>For example, to get the percent of the total population that is between ages 65-69, we can do this (because the data for total population and age-specific population have the same extent and resolution):</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">pop_pct65</span> <span class="kw">&lt;-</span> <span class="no">all_rasters</span><span class="kw">[[</span><span class="st">"UnitedStatesStates-2010-POP6569"</span>]] /
  <span class="no">all_rasters</span><span class="kw">[[</span><span class="st">"UnitedStatesStates-2010-TOTPOP"</span>]]

<span class="kw pkg">raster</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span>(<span class="no">pop_pct65</span>, <span class="kw">ext</span> <span class="kw">=</span> <span class="no">zoomed_extent</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"Percent of population ages 65-69 in 2010\n(raseterized area)"</span>)</pre></body></html></div>
<p>We can kind of see that the percent of population that is aged 65-69 is highest in a few places in warm places (in Arizona and Florida). To make this code run faster, I’ve only looked at 65-69 year olds, but really it’d be better to look at the percentage of the population that is 65+ by adding together all of the age categories. We leave that as an exercise for the reader</p>
<p>Also, comparing the population to the temperature on a grid level is more difficult. One solution is to use the <code>resample()</code> function from the raster package, which will use interpolation to put the rasters on the same grid. This is beyond the scope of this vignette.</p>
</div>
</div>
<div id="area-level-data" class="section level2">
<h2 class="hasAnchor">
<a href="#area-level-data" class="anchor"></a>Area level data</h2>
<p>IPUMS Terra includes data from both the raster datasets and microdata that have been aggregated up to a geographic boundary. To learn more about making these kind of extracts, see the guide here: <a href="https://www.terrapop.org/sites/www.terrapop.org/files/arealevel_tutorial_jan2017_final.pdf">IPUMS Terra Area Extract Guide</a>.</p>
<p>For the example in this vignette, I use the sample 2010 US Census and variables:</p>
<ul>
<li>Area Level: POPTOT, POP6569, POP7074, POP7579, POP80</li>
<li>Raster: TEMPAVGFEB (Mean)</li>
</ul>
<p>Also, be sure to include the boundary files in the extract.</p>
<p>Once we’ve made the extract and downloaded it, let’s check what’s available in it using the function <code><a href="../reference/ipums_list_files.html">ipums_list_files()</a></code>.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/ipums_list_files.html">ipums_list_files</a></span>(<span class="no">area_extract</span>)</pre></body></html></div>
<div id="reading-area-level-data" class="section level3">
<h3 class="hasAnchor">
<a href="#reading-area-level-data" class="anchor"></a>Reading area-level data</h3>
<p>We can load the data and geography together using the functions: <code><a href="../reference/read_terra_area.html">read_terra_area_sf()</a></code> or <code><a href="../reference/read_terra_area.html">read_terra_area_sp()</a></code></p>
<p>(The first loads as an <code>sf</code> object, while the second loads them as the older <code>SpatialPolygonsDataFrame</code> object)</p>
<p>Or we could load them separately using the functions: <code><a href="../reference/read_terra_area.html">read_terra_area()</a></code> and <code><a href="../reference/read_ipums_sf.html">read_ipums_sf()</a></code>/<code><a href="../reference/read_ipums_sf.html">read_ipums_sp()</a></code></p>
<p>For now, we focus on reading them together as an <code>sf</code> object, but the general idea of loading them is similar across all of these functions.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">terra_area</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/read_terra_area.html">read_terra_area_sf</a></span>(<span class="no">area_extract</span>)</pre></body></html></div>
<p>With the (currently) still in-development version of ggplot2, we can use the function <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> to make maps of the sf object.</p>
<p>Here’s a map of the average temperature in February, averaged over all rasters in a given geographic boundary:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">terra_area</span> <span class="kw">&lt;-</span> <span class="no">terra_area</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">feb_temp_c</span> <span class="kw">=</span> <span class="no">TEMPAVGFEB_mean_GEO2_US2010_WORLDCLIM</span> / <span class="fl">10</span>)


<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">terra_area</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="no">feb_temp_c</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"blank"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span>(<span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">180</span>, -<span class="fl">64</span>), <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">16.5</span>, <span class="fl">72.5</span>)) + <span class="co"># Crop out Alaska's East Hemisphere tail</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Average temp (deg C) in Feb\n1950-2010 (US Geo2)"</span>)</pre></body></html></div>
<p>Or we can look at a scatter comparing percentage of population older than 65 compared to average temperature in February.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">terra_area</span> <span class="kw">&lt;-</span> <span class="no">terra_area</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    <span class="kw">pct_pop_65</span> <span class="kw">=</span>
      (<span class="no">POP6569_GEO2_US2010_US2010A</span> + <span class="no">POP7074_GEO2_US2010_US2010A</span> +
         <span class="no">POP7579_GEO2_US2010_US2010A</span> + <span class="no">POP80_GEO2_US2010_US2010A</span>) /
      (<span class="no">TOTPOP_GEO2_US2010_US2010A</span>)
  )

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">terra_area</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">pct_pop_65</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">feb_temp_c</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Average temperature against percent of\npopulation over 65 by US Geo 2"</span>)</pre></body></html></div>
<p>Here we again see those retirement havens are in the warmer climates, though in general it doesn’t seem to be an incredibly strong relationship.</p>
</div>
</div>
<div id="microdata" class="section level2">
<h2 class="hasAnchor">
<a href="#microdata" class="anchor"></a>Microdata</h2>
<p>Finally, IPUMS Terra includes microdata with the area-level and raster data attached to it. To learn more about making these kind of extracts, see the guide here: <a href="https://www.terrapop.org/sites/www.terrapop.org/files/microdata_tutorial_oct2017.pdf">IPUMS Terra Microdata Extract Guide</a>.</p>
<p>For the example in this vignette, I use the sample 2010 US Census and variables: - Microdata: - Household: GEO2_US2010, GEO1_US21010 - Person: AGE, MIGUS2 - Area Level: (None) - Raster: TEMPAVGFEB (mean, also year-specific and at lowest geographic level available)</p>
<p>Also, be sure to include the boundary files in the extract.</p>
<p>Once we’ve made the extract and downloaded it, let’s check what’s available in it using the function <code><a href="../reference/ipums_list_files.html">ipums_list_files()</a></code>.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="../reference/ipums_list_files.html">ipums_list_files</a></span>(<span class="no">micro_extract</span>)</pre></body></html></div>
<div id="using-ipumsr-to-load-the-microdata" class="section level3">
<h3 class="hasAnchor">
<a href="#using-ipumsr-to-load-the-microdata" class="anchor"></a>Using ipumsr to load the microdata</h3>
<p>For microdata, we should read the microdata using <code><a href="../reference/read_terra_micro.html">read_terra_micro()</a></code> and the boundary files using either <code><a href="../reference/read_ipums_sf.html">read_ipums_sf()</a></code> or <code><a href="../reference/read_ipums_sf.html">read_ipums_sp()</a></code>. We don’t want to merge these two right away, because this would create a copy of each polygon for every observation in the microdata. Instead, generally we create area level summaries from the microdata and then merge them together using the <code>ipums_shape_*_join()</code> functions.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">terra_micro</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/read_terra_micro.html">read_terra_micro</a></span>(<span class="no">micro_extract</span>)
<span class="no">terra_micro_shapes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_sf.html">read_ipums_sf</a></span>(<span class="no">micro_extract</span>)</pre></body></html></div>
<p>Now we’ll create area level summaries for people older than 65 of what percent of the population has moved states in the past year.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">graph_data</span> <span class="kw">&lt;-</span> <span class="no">terra_micro</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">moved_states</span> <span class="kw">=</span> <span class="no">MIGUS2</span> <span class="kw">!=</span> <span class="no">GEO1_US2010</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">GEO2_US2010</span>, <span class="kw">age65plus</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">AGE</span> <span class="kw">&gt;=</span> <span class="fl">65</span>, <span class="st">"65 and older"</span>, <span class="st">"Under 65"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(
    <span class="kw">moved_states</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="no">moved_states</span>, <span class="no">PERWT</span>),
    <span class="kw">feb_temp_c</span> <span class="kw">=</span> <span class="no">TEMPAVGFEB_mean_GEO2_US2010_WORLDCLIM</span>[<span class="fl">1</span>] / <span class="fl">10</span>
  )

<span class="co"># ipums_shape_inner_join() will join the 2 datasets together, and keep</span>
<span class="co"># only observations that are in both files. In this case, we only</span>
<span class="co"># lose one observation that turns out to be the Great lakes.</span>
<span class="no">graph_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ipums_shape_left_join.html">ipums_shape_inner_join</a></span>(
  <span class="no">graph_data</span>,
  <span class="no">terra_micro_shapes</span>,
  <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"GEO2_US2010"</span> <span class="kw">=</span> <span class="st">"GEOID"</span>)
)

<span class="co"># Look at percent of population 65 and older who have moved in last year</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(
  <span class="no">graph_data</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">age65plus</span> <span class="kw">==</span> <span class="st">"65 and older"</span>),
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="no">moved_states</span>)
) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"blank"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span>(<span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">180</span>, -<span class="fl">64</span>), <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">16.5</span>, <span class="fl">72.5</span>)) + <span class="co"># Crop out Alaska's East Hemisphere tail</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"65 and older: percent moved from another\nstate in last year"</span>)</pre></body></html></div>
<p>Looks like some parts of Florida and Arizona might be sticking out again, but it’s hard to say. Again, there’s lots more we could look at here, but I’ll leave that up to you!</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.ipums.org">IPUMS</a> at the University of Minnesota.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '4ffa912ace97d2493f6ed39f20e94316',
    indexName: 'ipumsr',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
