<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>`ipumsr` Example - Terra â€¢ ipumsr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="`ipumsr` Example - Terra">
<meta property="og:description" content="ipumsr">
<meta property="og:image" content="http://tech.popdata.org/ipumsr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ipumsr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.5.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ipums.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ipums.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/value-labels.html">Value labels</a>
    </li>
    <li>
      <a href="../articles/ipums-geography.html">Geographic data in ipumsr</a>
    </li>
    <li>
      <a href="../articles/ipums-bigdata.html">Big IPUMS data</a>
    </li>
    <li>
      <a href="../articles/ipums-api.html">IPUMS data extract API</a>
    </li>
    <li class="divider">
    </li>
<li>
      <a href="../articles/ipums-cps.html">CPS exercise</a>
    </li>
    <li>
      <a href="../articles/ipums-nhgis.html">NHGIS exercise</a>
    </li>
    <li>
      <a href="../articles/ipums-terra.html">IPUMS Terra exercise</a>
    </li>
    <li>
      <a href="https://ipums.org/exercises.shtml" class="external-link">More project exercises</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ipums/ipumsr" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://forum.ipums.org" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
<li>
  <a href="https://www.ipums.org/" class="external-link">
    <span class="fa fa-globe"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>
<code>ipumsr</code> Example - Terra</h1>
                        <h4 data-toc-skip class="author">Minnesota
Population Center</h4>
            
            <h4 data-toc-skip class="date">2022-06-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ipums/ipumsr/blob/HEAD/vignettes/ipums-terra.Rmd" class="external-link"><code>vignettes/ipums-terra.Rmd</code></a></small>
      <div class="hidden name"><code>ipums-terra.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="ipums-terra-integrated-population-and-environment-data">IPUMS Terra: Integrated Population and Environment Data<a class="anchor" aria-label="anchor" href="#ipums-terra-integrated-population-and-environment-data"></a>
</h2>
<p>The IPUMS Terra project allows you to create datasets for your
research that seamlessly combine area-level data, raster data and
microdata and use whichever of these data formats is best for your
analysis.</p>
<p>Raster data is data that describes the world on a grid - each cell in
the grid gets its own value. Temperature is an example of data available
in raster form from IPUMS Terra - satellite imagery allows geographers
to create estimates of average temperature for approximately 1 km square
grids across the globe.</p>
<p>Area level data is data that represents a particular area. In IPUMS
Terra, the areas are political boundaries, like countries, states or
provinces.</p>
<p>Microdata is data that describe each person separately. In IPUMS
Terra, this data generally comes from census data from the IPUMS
International project.</p>
<p>Learn more about the kinds of data in IPUMS Terra here: <a href="https://data.terrapop.org" class="external-link uri">https://data.terrapop.org</a></p>
<p><code>ipumsr</code> helps you read this data into R so you can
continue your analysis.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.ipums.org" class="external-link">ipumsr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="learning-more-about-spatial-data-in-r">Learning more about spatial data in R<a class="anchor" aria-label="anchor" href="#learning-more-about-spatial-data-in-r"></a>
</h2>
<p>This vignette focuses on the mechanics of getting spatial data from
IPUMS Terra into R, but it glosses over the details about what you can
do after youâ€™ve loaded it. To learn more about these, here are some
resources:</p>
<ul>
<li>
<strong><a href="https://rspatial.org/" class="external-link">https://rspatial.org/</a></strong> has a
great set of tutorials and other documentation about spatial tools.</li>
<li>The <strong><a href="https://github.com/r-spatial/sf" class="external-link">sf package
github page</a></strong> has links to documentation about the sf
package, which is great for working with the area level files.</li>
<li>The <strong><a href="https://cran.r-project.org/view=Spatial" class="external-link">Spatial Task View on
CRAN</a></strong> organizes the packages that provide tools for spatial
analysis.</li>
</ul>
</div>
<div class="section level2">
<h2 id="example-age-and-migration-patterns-by-temperature-in-the-us">Example: Age and migration patterns by temperature in the US<a class="anchor" aria-label="anchor" href="#example-age-and-migration-patterns-by-temperature-in-the-us"></a>
</h2>
<p>On this cold February day in Minnesota, I wonder how migration
between areas of the US is affected by the temperature and whether I see
any evidence of my preconception that older people retire to warmer
climates. As a quick aside - this analysis might be better served by
data from the IPUMS NHGIS project (see
<code>vigntette("ipums-nhgis")</code>), because it often has more
granular geographic areas than IPUMS Terra, which which pulls from our
microdata projects, but I use Terra to show off the way it helps moving
between data types.</p>
<div class="section level3">
<h3 id="raster-data">Raster data<a class="anchor" aria-label="anchor" href="#raster-data"></a>
</h3>
<p>IPUMS Terra includes raster data on the average temperature 1950-2000
by month from the WorldClim dataset. It also converts area-level
summaries of some variables from the US census microdata to raster grid,
so we can get the total population and population by age on a grid.</p>
<p>For the example in this vignette, I use the sample 2010 US Census and
variables:</p>
<ul>
<li>Area Level: POPTOT, POP6569, POP7074, POP7579, POP80 (year-specific
and at the lowest geographic level available)</li>
<li>Raster: TEMPAVGFEB (mean, also year-specific and at lowest
geographic level available)</li>
</ul>
<p>Once weâ€™ve made the extract and downloaded it, letâ€™s check whatâ€™s
available in it using the function <code><a href="../reference/ipums_list_files.html">ipums_list_files()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ipums_list_files.html">ipums_list_files</a></span><span class="op">(</span><span class="va">raster_extract</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 Ã— 2</span></span>
<span class="co">#&gt;   type   file                                          </span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> raster TEMPAVGFEBUS2013.tiff                         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> raster UnitedStatesStates-2010_rasterized_geoids.tiff</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> raster UnitedStatesStates-2010-TOTPOP.tiff           </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> raster UnitedStatesStates-2010-POP6569.tiff          </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> raster UnitedStatesStates-2010-POP7074.tiff          </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> raster UnitedStatesStates-2010-POP7579.tiff          </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">7</span> raster UnitedStatesStates-2010-POP80.tiff</span></code></pre></div>
<p>To load the data, ipumsr provides two functions:
<code><a href="../reference/read_terra_raster.html">read_terra_raster()</a></code> and
<code><a href="../reference/read_terra_raster.html">read_terra_raster_list()</a></code>. The first reads a single raster,
and the second loads 1 or more and puts them into a list.</p>
<div class="section level4">
<h4 id="reading-a-single-raster">Reading a single raster<a class="anchor" aria-label="anchor" href="#reading-a-single-raster"></a>
</h4>
<p>Letâ€™s first look at loading a single layer, by making a map of the
<code>TEMPAVGFEB</code> layer (called <code>TEMPAVGFEBUS2013.tiff</code>
in the file, but we can refer to it with the <code><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches()</a></code>
function).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">febtemp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_terra_raster.html">read_terra_raster</a></span><span class="op">(</span><span class="va">raster_extract</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"TEMPAVGFEB"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Use of data from IPUMS Terra is subject to conditions including that users</span>
<span class="co">#&gt; should cite the data appropriately. Use command `ipums_conditions()` for more</span>
<span class="co">#&gt; details.</span></code></pre></div>
<p>The details of making good maps with raster data are beyond this
tutorial, (see below for some pointers on where to learn more), but just
to prove that we got the data, we can use the raster packageâ€™s built in
<code><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">plot()</a></code> method.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Crop map a bit</span>
<span class="va">zoomed_extent</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="op">-</span><span class="fl">64</span>, <span class="fl">16.5</span>, <span class="fl">72.5</span><span class="op">)</span><span class="op">)</span>

<span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">febtemp</span> <span class="op">/</span> <span class="fl">10</span>, ext <span class="op">=</span> <span class="va">zoomed_extent</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Average temp (deg C) in Feb\n1950-2010 (US raster)"</span><span class="op">)</span></code></pre></div>
<p><img src="ipums-terra_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
</div>
<div class="section level4">
<h4 id="reading-multiple-rasters">Reading multiple rasters<a class="anchor" aria-label="anchor" href="#reading-multiple-rasters"></a>
</h4>
<p>We can also read multiple rasters and put them into a list
object.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_rasters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_terra_raster.html">read_terra_raster_list</a></span><span class="op">(</span><span class="va">raster_extract</span><span class="op">)</span>
<span class="co">#&gt; Use of data from IPUMS Terra is subject to conditions including that users</span>
<span class="co">#&gt; should cite the data appropriately. Use command `ipums_conditions()` for more</span>
<span class="co">#&gt; details.</span></code></pre></div>
<p>Now we can make a map as before; this would be identical to the one
above.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">all_rasters</span><span class="op">[[</span><span class="st">"TEMPAVGFEBUS2013"</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="fl">10</span>, ext <span class="op">=</span> <span class="va">zoomed_extent</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Average temp (deg C) in Feb\n1950-2010 (US raster)"</span><span class="op">)</span></code></pre></div>
<p>Again the details of spatial analysis of raster data in R are beyond
the scope of this document (see below for some resources), but it one
thing to keep in mind is that IPUMS Terra data, especially data from
different sources (like rasterized area level data vs.Â the temperature
data) may not have the same spatial extent (coverage area) or
resolution, so you may need to do some conversion.</p>
<p>For example, to get the percent of the total population that is
between ages 65-69, we can do this (because the data for total
population and age-specific population have the same extent and
resolution):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pop_pct65</span> <span class="op">&lt;-</span> <span class="va">all_rasters</span><span class="op">[[</span><span class="st">"UnitedStatesStates-2010-POP6569"</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> 
  <span class="va">all_rasters</span><span class="op">[[</span><span class="st">"UnitedStatesStates-2010-TOTPOP"</span><span class="op">]</span><span class="op">]</span>

<span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pop_pct65</span>, ext <span class="op">=</span> <span class="va">zoomed_extent</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Percent of population ages 65-69 in 2010\n(raseterized area)"</span><span class="op">)</span></code></pre></div>
<p><img src="ipums-terra_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
<p>We can kind of see that the percent of population that is aged 65-69
is highest in a few places in warm places (in Arizona and Florida). To
make this code run faster, Iâ€™ve only looked at 65-69 year olds, but
really itâ€™d be better to look at the percentage of the population that
is 65+ by adding together all of the age categories. We leave that as an
exercise for the reader</p>
<p>Also, comparing the population to the temperature on a grid level is
more difficult. One solution is to use the <code>resample()</code>
function from the raster package, which will use interpolation to put
the rasters on the same grid. This is beyond the scope of this
vignette.</p>
</div>
</div>
<div class="section level3">
<h3 id="area-level-data">Area level data<a class="anchor" aria-label="anchor" href="#area-level-data"></a>
</h3>
<p>IPUMS Terra includes data from both the raster datasets and microdata
that have been aggregated up to a geographic boundary.</p>
<p>For the example in this vignette, I use the sample 2010 US Census and
variables:</p>
<ul>
<li>Area Level: POPTOT, POP6569, POP7074, POP7579, POP80</li>
<li>Raster: TEMPAVGFEB (Mean)</li>
</ul>
<p>Also, be sure to include the boundary files in the extract.</p>
<p>Once weâ€™ve made the extract and downloaded it, letâ€™s check whatâ€™s
available in it using the function <code><a href="../reference/ipums_list_files.html">ipums_list_files()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ipums_list_files.html">ipums_list_files</a></span><span class="op">(</span><span class="va">area_extract</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 Ã— 2</span></span>
<span class="co">#&gt;   type  file                                  </span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> data  data_4618_IPUMS_US_SLAD_2010.csv      </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> shape boundaries_4618_IPUMS_US_SLAD_2010.zip</span></code></pre></div>
<div class="section level4">
<h4 id="reading-area-level-data">Reading area-level data<a class="anchor" aria-label="anchor" href="#reading-area-level-data"></a>
</h4>
<p>We can load the data and geography together using the functions:
<code><a href="../reference/read_terra_area.html">read_terra_area_sf()</a></code> or
<code><a href="../reference/read_terra_area.html">read_terra_area_sp()</a></code></p>
<p>(The first loads as an <code>sf</code> object, while the second loads
them as the older <code>SpatialPolygonsDataFrame</code> object)</p>
<p>Or we could load them separately using the functions:
<code><a href="../reference/read_terra_area.html">read_terra_area()</a></code> and
<code><a href="../reference/read_ipums_sf.html">read_ipums_sf()</a></code>/<code><a href="../reference/read_ipums_sf.html">read_ipums_sp()</a></code></p>
<p>For now, we focus on reading them together as an <code>sf</code>
object, but the general idea of loading them is similar across all of
these functions.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">terra_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_terra_area.html">read_terra_area_sf</a></span><span class="op">(</span><span class="va">area_extract</span><span class="op">)</span>
<span class="co">#&gt; Use of data from IPUMS Terra is subject to conditions including that users</span>
<span class="co">#&gt; should cite the data appropriately. Use command `ipums_conditions()` for more</span>
<span class="co">#&gt; details.</span>
<span class="co">#&gt; options:        ENCODING=UTF-8 </span>
<span class="co">#&gt; Reading layer `boundaries_4618_IPUMS_US_SLAD_2010' from data source </span>
<span class="co">#&gt;   `C:\Users\derek\AppData\Local\Temp\Rtmp8YCA5t\file3f68479e2d59\boundaries_4618_IPUMS_US_SLAD_2010.shp' </span>
<span class="co">#&gt;   using driver `ESRI Shapefile'</span>
<span class="co">#&gt; Simple feature collection with 2070 features and 2 fields</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -179.1526 ymin: 18.91236 xmax: 179.7758 ymax: 71.38875</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span></code></pre></div>
<p>With the (currently) still in-development version of ggplot2, we can
use the function <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code> to make maps of the sf
object.</p>
<p>Hereâ€™s a map of the average temperature in February, averaged over
all rasters in a given geographic boundary:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">terra_area</span> <span class="op">&lt;-</span> <span class="va">terra_area</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>feb_temp_c <span class="op">=</span> <span class="va">TEMPAVGFEB_mean_GEO2_US2010_WORLDCLIM</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span>


<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">terra_area</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">feb_temp_c</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"blank"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="op">-</span><span class="fl">64</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16.5</span>, <span class="fl">72.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Crop out Alaska's East Hemisphere tail</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Average temp (deg C) in Feb\n1950-2010 (US Geo2)"</span><span class="op">)</span></code></pre></div>
<p><img src="ipums-terra_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
<p>Or we can look at a scatter comparing percentage of population older
than 65 compared to average temperature in February.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">terra_area</span> <span class="op">&lt;-</span> <span class="va">terra_area</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    pct_pop_65 <span class="op">=</span>
      <span class="op">(</span><span class="va">POP6569_GEO2_US2010_US2010A</span> <span class="op">+</span> <span class="va">POP7074_GEO2_US2010_US2010A</span> <span class="op">+</span>
         <span class="va">POP7579_GEO2_US2010_US2010A</span> <span class="op">+</span> <span class="va">POP80_GEO2_US2010_US2010A</span><span class="op">)</span> <span class="op">/</span>
      <span class="op">(</span><span class="va">TOTPOP_GEO2_US2010_US2010A</span><span class="op">)</span>
  <span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">terra_area</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pct_pop_65</span>, y <span class="op">=</span> <span class="va">feb_temp_c</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Average temperature against percent of\npopulation over 65 by US Geo 2"</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 1 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="ipums-terra_files/figure-html/unnamed-chunk-13-1.png" width="576"></p>
<p>Here we again see those retirement havens are in the warmer climates,
though in general it doesnâ€™t seem to be an incredibly strong
relationship.</p>
</div>
</div>
<div class="section level3">
<h3 id="microdata">Microdata<a class="anchor" aria-label="anchor" href="#microdata"></a>
</h3>
<p>Finally, IPUMS Terra includes microdata with the area-level and
raster data attached to it.</p>
<p>For the example in this vignette, I use the sample 2010 US Census and
variables: - Microdata: - Household: GEO2_US2010, GEO1_US21010 - Person:
AGE, MIGUS2 - Area Level: (None) - Raster: TEMPAVGFEB (mean, also
year-specific and at lowest geographic level available)</p>
<p>Also, be sure to include the boundary files in the extract.</p>
<p>Once weâ€™ve made the extract and downloaded it, letâ€™s check whatâ€™s
available in it using the function <code><a href="../reference/ipums_list_files.html">ipums_list_files()</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ipums_list_files.html">ipums_list_files</a></span><span class="op">(</span><span class="va">micro_extract</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 Ã— 2</span></span>
<span class="co">#&gt;   type  file                                  </span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> data  terrapop_extract_4621.csv.gz          </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> shape boundaries_4621_IPUMS_US_SLAD_2010.zip</span></code></pre></div>
<div class="section level4">
<h4 id="using-ipumsr-to-load-the-microdata">Using ipumsr to load the microdata<a class="anchor" aria-label="anchor" href="#using-ipumsr-to-load-the-microdata"></a>
</h4>
<p>For microdata, we should read the microdata using
<code><a href="../reference/read_terra_micro.html">read_terra_micro()</a></code> and the boundary files using either
<code><a href="../reference/read_ipums_sf.html">read_ipums_sf()</a></code> or <code><a href="../reference/read_ipums_sf.html">read_ipums_sp()</a></code>. We donâ€™t
want to merge these two right away, because this would create a copy of
each polygon for every observation in the microdata. Instead, generally
we create area level summaries from the microdata and then merge them
together using the <code>ipums_shape_*_join()</code> functions.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">terra_micro</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_terra_micro.html">read_terra_micro</a></span><span class="op">(</span><span class="va">micro_extract</span><span class="op">)</span>
<span class="co">#&gt; Use of data from IPUMS Terra is subject to conditions including that users</span>
<span class="co">#&gt; should cite the data appropriately. Use command `ipums_conditions()` for more</span>
<span class="co">#&gt; details.</span>
<span class="va">terra_micro_shapes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ipums_sf.html">read_ipums_sf</a></span><span class="op">(</span><span class="va">micro_extract</span><span class="op">)</span>
<span class="co">#&gt; options:        ENCODING=latin1 </span>
<span class="co">#&gt; Reading layer `boundaries_4621_IPUMS_US_SLAD_2010' from data source </span>
<span class="co">#&gt;   `C:\Users\derek\AppData\Local\Temp\Rtmp8YCA5t\file3f6852cb2e3e\boundaries_4621_IPUMS_US_SLAD_2010.shp' </span>
<span class="co">#&gt;   using driver `ESRI Shapefile'</span>
<span class="co">#&gt; Simple feature collection with 2070 features and 2 fields</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -179.1526 ymin: 18.91236 xmax: 179.7758 ymax: 71.38875</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span></code></pre></div>
<p>Now weâ€™ll create area level summaries for people older than 65 of
what percent of the population has moved states in the past year.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">graph_data</span> <span class="op">&lt;-</span> <span class="va">terra_micro</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>moved_states <span class="op">=</span> <span class="va">MIGUS2</span> <span class="op">!=</span> <span class="va">GEO1_US2010</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">GEO2_US2010</span>, age65plus <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">65</span>, <span class="st">"65 and older"</span>, <span class="st">"Under 65"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>
    moved_states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">moved_states</span>, <span class="va">PERWT</span><span class="op">)</span>,
    feb_temp_c <span class="op">=</span> <span class="va">TEMPAVGFEB_mean_GEO2_US2010_WORLDCLIM</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fl">10</span>
  <span class="op">)</span>
<span class="co">#&gt; `summarise()` has grouped output by 'GEO2_US2010'. You can override using the</span>
<span class="co">#&gt; `.groups` argument.</span>

<span class="co"># ipums_shape_inner_join() will join the 2 datasets together, and keep</span>
<span class="co"># only observations that are in both files. In this case, we only</span>
<span class="co"># lose one observation that turns out to be the Great lakes.</span>
<span class="va">graph_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ipums_shape_left_join.html">ipums_shape_inner_join</a></span><span class="op">(</span>
  <span class="va">graph_data</span>, 
  <span class="va">terra_micro_shapes</span>,
  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GEO2_US2010"</span> <span class="op">=</span> <span class="st">"GEOID"</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; Some observations were lost in the join (1 observations in the shape file). See</span>
<span class="co">#&gt; `join_failures(...)` for more details.</span>

<span class="co"># Look at percent of population 65 and older who have moved in last year</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>
  <span class="va">graph_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age65plus</span> <span class="op">==</span> <span class="st">"65 and older"</span><span class="op">)</span>, 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">moved_states</span><span class="op">)</span>
<span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"blank"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="op">-</span><span class="fl">64</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16.5</span>, <span class="fl">72.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Crop out Alaska's East Hemisphere tail</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"65 and older: percent moved from another\nstate in last year"</span><span class="op">)</span></code></pre></div>
<p><img src="ipums-terra_files/figure-html/unnamed-chunk-16-1.png" width="576"></p>
<p>Looks like some parts of Florida and Arizona might be sticking out
again, but itâ€™s hard to say. Again, thereâ€™s lots more we could look at
here, but Iâ€™ll leave that up to you!</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.ipums.org" class="external-link">IPUMS</a> at the University of Minnesota.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> .</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '4ffa912ace97d2493f6ed39f20e94316',
    indexName: 'ipumsr',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
