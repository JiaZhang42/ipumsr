---
title: "`ripums` Example - NHGIS"
author: "Minnesota Population Center"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ipums-nhgis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# IPUMS - NHGIS Extraction and Analysis

## Exercise 1
OBJECTIVE: Gain an understanding of how the NHGIS datasets are structured and how they can
be leveraged to explore your research interests. This exercise will use an NHGIS dataset to
explore slavery in the United States in 1830.

This vignette is adapted from the CPS Data Training Exercise available here:
[https://pop.umn.edu/sites/pop.umn.edu/files/final_review_-_cps_spss_exercise_1_0.pdf]()

### Research Question
What was the state‐level distribution of slavery in 1830?

### Objectives
- Create and download an NHGIS data extract
- Unzip data file and open in R
- Analyze the data using R
- Validate data analysis work using answer key

## Download Extract from IPUMS Website
1) **Log in to NHGIS**
- Go to [http://www.nhgis.org]() and click on ‘Login’ in the top right.
- If you have already registered on any Minnesota Population Center website…
    - If you remember your password, log in now. Otherwise, click the "Forgot
      your password?" link on the right and follow the instructions.
- If you have not already registered...
    - Click on the "Create an account"" link on the right, fill in the required
      information, and submit your registration.
- You will then enter the NHGIS Data Finder...

2) **Find Tables**
- Quick instructions
    - Apply any combination of the four filters below to find 1830 slavery related tables
        - **Geographic Levels** = 'State'
        - **Years** = '1830'
        - **Topics** = 'Slavery'
        - **Datasets** = '1830_cPop'

- Guided instructions
    - Suppose you were interested not only in slavery, but in all that's covered by the 1830 Census.
        - To view all available 1830 data, use only the Years Filter set to '1830'.
          1) How many tables are available from the 1830 Census? _________
          2) Other than slave status, what are some other topics could we learn about for 1830?
          ___________________________________________________________

    - Locate the Desired Table
        - Let's focus in on the slavery topic. To narrow the results, apply the Topics Filter of
          'Slavery'. (You can find it at the bottom of the list of POPULATION topics.)
        - The Select Data grid now lists all the tables related to the topic of Slavery. If you
          don’t also have the Years Filter on, scroll down to find the 1830 tables, or utilize
          additional filters to further limit the available tables.
        - Locate this 1830 table and answer the questions that follow: "NT12. Race/Slave Status by Sex"
      
    - Learn About the Table in the Data Finder
        3) Click the table name to see additional information. How many variables does this
        table contain? ____________
        4) For which geographic levels is the table available? ____________________________
        5) Close the table pop‐up window and inspect the Select Data table... What is the
        universe for this table? ______________________
        6) What differentiates this table from the other available slavery tables from 1830?         __________________________________________________________________
        7) Name a percentage or ratio this table would allow us to calculate that the other
        tables would not, based on the counts available in each table? _____________________
        ____________________________________________________________________________

3) **Create a Data Extract**
Creating a data extract requires the user to select the table(s), specify a geographic
level, and select the data layout structure...

- Click the plus sign to the left of the table name to add table NT12 to your Data Cart.
- Click on the "GIS Boundary Files" Tab
- Click on the plus sign to hte left of the State Goegraphic Level Table
- Click the green Continue button in your Data Cart.
- On the Data Options screen, select the geographic level of ‘State’.
- Click the green Continue button in your Data Cart.
- On the Review and Submit screen, select the "Comma delimited (best for GIS)"
  option (it doesn't matter if you include the descriptive heaer rows or not), 
  add an extract description if you wish, and click Submit.

4) **Download the Data Extract**
From the Extracts History page, you will be able to download your data extract once
it has finished processing, typically within a few minutes. You may leave this page
and return once you have received the email alerting you to your finished extract.

If you refresh your browser window (click on the loop icon at top, or press F5), you
will see the extract status change from ‘queued’ to ‘in progress’ to ‘complete’, at
which time you will be able to click the ‘tables’ link to download the data.

- Return to the Extracts History page if not currently there.
- Right‐click on the ‘tables’ link for the extract you created.
- Choose 'Save Target As...' (or 'Save link as...').
- Save the zip file into ‘Documents’.
- Repeat the process for the GIS data (right-click, choose 'Save Target As...', ...)
- The R package can read theh extracts as zip files, or if you wish to open in
  other programs, you can unzip them, by: Right‐clicking on the 'nhgis0001_csv.zip' 
  file, and select Extract All... Then click the Extract button. (Repeat for the shape
  if you desire).

## Getting the data into R ##
You will need to change the filepaths noted below to the place where you have
saved the extracts.

## Getting the data into R ##
You will need to change the filepaths noted below to the place where you have
saved the extracts.

```{r}
library(ripums)
library(dplyr, warn.conflicts = FALSE)
library(haven)
library(sf)
```

```{r, echo = FALSE}
nhgis_csv_file <- ripums_example("nhgis0010_csv.zip")
nhgis_shp_file <- ripums_example("nhgis0010_shape.zip")
```
```{r, eval = FALSE}
# Change these filepaths to the filepaths of your downloaded extract
nhgis_csv_file <- "C:/Users/My Name/My Documents/nhgis0001_csv.zip"
nhgis_shp_file <- "C:/Users/My Name/My Documents/nhgis0001_shape.zip"
```
```{r}
nhgis_ddi <- read_ipums_codebook(nhgis_csv_file) # Contains metadata, nice to have as separate object
nhgis <- read_nhgis_sf(
  data_file = nhgis_csv_file,
  shape_file = nhgis_shp_file
)
```

## Exercises
### Analyze the Data
8) How many states/territories are included in this table? _________________________

9) Why do you think other states are missing? ___________________________________
____________________________________________________________________________

10) Create a new variable called total_pop, with the total population for each state, by summing the counts in columns ABO001 to ABO006. Which state had the largest population? ________________________________________

11) Create a variable called slave_pop, with the total slave population by summing the variables ABO003 and ABO004. Which state had the largest slave population?__________________

12) Create a variable called pct_slave with the Slave Population divided by the Total Population. Which states had the highest and lowest Percent Slave Population?
Highest:___________________________________
Lowest:____________________________________

13) Are there any surprises, or is it as you expected? _____________________________  
____________________________________________________________________________

### Inspect the Codebook
Open the .txt codebook file that is in the same folder as the comma delimited file you
have already analyzed. The codebook file is a valuable reference containing
information about the table or tables you’ve downloaded.

Some of the information provided in the codebook can be read into R, using the function
`read_ipums_codebook()`.

14) What is the proper citation to provide when using NHGIS data in publications or
researcher reports? ___________________________________________________________

15) What is the email address for NHGIS to share any research you have published?
(You can also send questions you may have about the site. We’re happy to help!) _______________________________

### Bonus - Make Maps using R
One of the reasons we are excited about bringing IPUMS data to R is the 
GIS capabilities available for free in R. 

16) Make a map of the percent of the population that are slaves.

## Answers
```{r}
# 1) How many tables are available from the 1830 Census? 
#     A: Fifteen (15)


# 2) Other than slave status, what other topics of interest could we learn about for 1830?
#     A: Population that is urban, particular ages, deaf and dumb, blind, and foreign born
#        not naturalized.


# 3) How many variables does this table contain? 
#     A: Six (6)


# 4) For which geographic levels is the table available? 
#     A: Nation, State, & County


# 5) What is the universe for this table? 
#     A: Persons


# 6) What differentiates this table from the other available slavery tables from 1830? 
#     A: It includes the counts of "white" persons, in addition to "colored" persons


# 7) Name a percentage or ratio this table would allow us to calculate that the other
# tables would not, based on the counts available in each table: 
#     A: Percentage of total population in slavery, or ratio of slave:free population


# 8) How many states/territories are included in this table? 
length(table(nhgis$STATE))
#     A:  Twenty‐Eight (28)


# 9) Why do you think other states are missing? 
table(nhgis$STATE)
#     A: In 1830, there were not any other states yet! Every decennial census is a 
#        historical snapshot, and NHGIS provides census counts just as they were 
#        originally reported without "filling in" any information for newer areas.


# 10) Which state had the largest population? 
nhgis <- nhgis %>%
  mutate(total_pop = ABO001 + ABO002 + ABO003 + ABO004 + ABO005 + ABO006)

nhgis %>%
  select(STATE, total_pop) %>%
  arrange(desc(total_pop)) %>%
  slice(1:5)
#     A: New  York


# 11) Which state had the largest slave population? 
nhgis <- nhgis %>%
  mutate(slave_pop = ABO003 + ABO004)

nhgis %>%
  select(STATE, slave_pop) %>%
  arrange(desc(slave_pop)) %>%
  slice(1:5)
#     A: Virginia 


# 12) Which states had the highest and lowest Percent Slave Population?
nhgis <- nhgis %>%
  mutate(pct_slave = slave_pop / total_pop)

nhgis %>%
  select(STATE, pct_slave) %>%
  filter(pct_slave %in% c(min(pct_slave, na.rm = TRUE), max(pct_slave, na.rm = TRUE)))
#     A: South Carolina (54.27%) and Vermont (0.00%)


# 13) Are there any surprises, or is it as you expected?
nhgis %>%
  filter(pct_slave > 0.5) %>%
  select(STATE, slave_pop, total_pop, pct_slave)

nhgis %>%
  filter(STATE %in% c("New York", "New Jersey")) %>%
  select(STATE, slave_pop, total_pop, pct_slave)
#     A: Possibilities: Did you know some states had more slaves than free persons? Did
#        you know that some “free states” were home to substantial numbers of slaves?


# 14) What is the proper citation to provide when using NHGIS data?
cat(ipums_file_info(nhgis_ddi)$conditions)

#     A: Minnesota Population Center. National Historical Geographic Information
#        System: Version 11.0 [Database]. Minneapolis: University of Minnesota. 2016.
#        http://doi.org/10.18128/D050.V11.0.


# 15) What is the email address for NHGIS to share any research you have published?
#     A: (You can also send questions you may have about the site. We’re happy to help!)
#     nhgis@umn.edu

```
```{r, fig.height = 4, fig.width = 6}
# 16) Make a map of the percent of the population that are slaves.

# Note the function `geom_sf()` is a very new function, so you may need to update
# ggplot2 to run.
library(ggplot2)
if ("geom_sf" %in% getNamespaceExports("ggplot2")) {
  ggplot(data = nhgis, aes(fill = pct_slave)) +
    geom_sf() + 
    scale_fill_continuous("", labels = scales::percent) + 
    labs(
      title = "Percent of Population that was Enslaved by State",
      subtitle = "1830 Census",
      caption = paste0("Source: ", ipums_file_info(nhgis_ddi)$ipums_project)
    )
}

```

