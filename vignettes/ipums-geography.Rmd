---
title: "Geographic Data in `ripums`"
author: "Minnesota Population Center"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ipums-geography}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Don't give instructions about downloading data for yourself for geography data
# because some of the files (like the small shape file) aren't available.
ripumsexamples_file <- system.file("extdata", "nhgis0010_csv.zip", package = "ripumsexamples")

if (!file.exists(ripumsexamples_file)) {
  message(paste0(
    "Could not find data and so could not run vignette.\n\n",
    "The data is also available on github. You can install it using the following ",
    "commands: \n",
    "  if (!require(devtools)) install.packages('devtools')\n",
    "  devtools::install_github('mnpopcenter/ripums/ripumsexamples')\n",
    "After installation, the data should be available for this vignette.\n\n"
  ))
  knitr::opts_chunk$set(eval = FALSE)
}
```
As IPUMS data has incorporated more geographic data, several different approaches
for providing this data have developed. 

- Microdata projects like 
[IPUMS DHS](https://www.idhsdata.org/idhs/gis.shtml), 
[IPUMS International](https://international.ipums.org/international/geography_gis.shtml) 
and [IPUMS USA](https://usa.ipums.org/usa/volii/tgeotools.shtml) provide the shape 
files on separate pages.
- [NHGIS](https://nhgis.org) provides access to the shape files relevant to your
current extact as part of the system to create the data extract.
- [IPUMS Terra](https://www.terrapop.org/) provides shape files along with the extract
and allows for aggregating microdata and raster data into the boundaries. 

The ripums package does not yet support IPUMS Terra data, but does try to help 
work with NHGIS and the microdata projects' geographic data. We hope to add
support for IPUMS Terra soon.

The examples here focus on the specifics of working with IPUMS geographic data and only
provided minimal instruction about how to actually use this data. However, please do 
not forget that once the data is loaded into R, there are many cool things that you can 
do with it. See the bottom of this vignette for more some resources that focus more
on actualy using the geographic data.

## R's Geospatial Packages: `sf` vs `sp`
The `ripums` package allows for loading geospatial data in two formats (sf for
Simple Features and sp for Spatial). The `sf` package is relatively new, and so 
does not have as widespread support as the `sp` package. However, (in my opinion)
it does allow for easier analysis, and so may be a better place to start if you
have not used GIS data in R before.

All examples in this vignette will use the sf package, but the functionality of the sp
functions is generally similar. I have tried to make notes when something would be 
different for the sp package.

## Geographic Data from IPUMS Microdata Projects (DHS / International / USA)
This vignette focuses on the mechanics of loading the data into R and then using
it in analysis. Before you work on the data for yourself, I recommend reading
the specifics about the project's geographic data on the IPUMS website 
([IPUMS DHS](https://www.idhsdata.org/idhs/gis.shtml) 
[IPUMS International](https://international.ipums.org/international/geography_gis.shtml) 
and [IPUMS USA](https://usa.ipums.org/usa/volii/tgeotools.shtml)). These pages 
have important information about the availability of data and our process for
standardizing geographic units across time. Because the data comes from
different sources, each project has its own pecuilarities.

### Downloading Geographic Data
The geographic data for microdata projects is unfortunately not integrated
into the data extract system at this time. To get the geographic data, you
will need to include the geographic ID variables in your variable list
(such as [GEO_BJ1996_2011](https://www.idhsdata.org/idhs-action/variables/GEO_BJ1996_2011) 
or [GEO_GH2003](https://www.idhsdata.org/idhs-action/variables/GEO_GH2003) for DHS, 
[GEOLEV1](https://international.ipums.org/international-action/variables/GEOLEV1) or 
[GEO2_FJ2007](https://international.ipums.org/international-action/variables/GEO2_FJ2007) 
for IPUMS International, or [CONSPUMA](https://usa.ipums.org/usa-action/variables/CONSPUMA) 
or [MIGPUMAS](https://usa.ipums.org/usa-action/variables/MIGPUMAS) for IPUMS USA).

Then, after downloading the data extract, you need to download the relevant shape files
from the geography section of the project's website 
([IPUMS DHS](https://www.idhsdata.org/idhs/gis.shtml) 
[IPUMS International](https://international.ipums.org/international/geography_gis.shtml) 
and [IPUMS USA](https://usa.ipums.org/usa/volii/tgeotools.shtml)).

### IPUMS Geography Harmonization
TKTKTK

### Loading Geographic Data and Merging With Data
The `read_ipums_micro` function loads the data and the `read_ipums_sf` 
(or `read_ipums_sp`) function loads the shape files. 

As an example, let's analyze a data extract I created for Colombia, Ecuador and Peru 
on the type of fuel used for cooking in the households of children 0-5 years
old. Here's how we can load the data into R:
```{r}
suppressPackageStartupMessages({
  library(ripums)
  library(sf)
  library(dplyr)
  library(ggplot2)
})

ipumsi_data_file <- system.file("extdata", "ipumsi_00011.xml", package = "ripumsexamples")
ipumsi_ddi <- read_ipums_ddi(ipumsi_data_file)
ipumsi_data <- read_ipums_micro(ipumsi_data_file, verbose = FALSE)
```

Since the variable FUELCOOK was available for multiple years in Colombia,
we use the harmonized Colombia administrative level 1 shape file. We can load
it into R using the following command:
```{r}
colombia_shape_file <- system.file("extdata", "geo1_co1964_2005.zip", package = "ripumsexamples")
colombia_shape <- read_ipums_sf(colombia_shape_file, verbose = FALSE)
```

Notice that there are way more observations in the data (because many people live in each
geographic unit). Before we combine the data and shapes, we really want to summarize the 
data by geographic unit.

To do so let's calculate the percentage of children living in a house where the cook
fuel is solid. 
```{r}
# Convert labelled values to factors where useful (and zap elsewhere)
# See the value-labels vignette for more on this process.
fuel_labels <- ipums_val_labels(ipumsi_data$FUELCOOK)
fuel_missing_lbls <- c(
  "NIU (not in universe)", "Multiple fuels", "Other combinations", "Other", "Unknown/missing"
)
fuel_solid_vals <- c(50:56, 61, 73, 74, 75)

ipumsi_data <- ipumsi_data %>%
  mutate_at(vars(COUNTRY, SAMPLE, AGE2), ~as_factor(lbl_clean(.))) %>%
  # We will get labels from shape file for geographic variables
  mutate_at(vars(starts_with("GEO")), zap_labels) %>% 
  mutate(
    SOLIDFUEL = FUELCOOK %>% 
      lbl_na_if(~.lbl %in% fuel_missing_lbls) %>%
      lbl_relabel(
        lbl(0, "Non-solid Fuel") ~ !.val %in% fuel_solid_vals,
        lbl(1, "Solid Fuel") ~ .val %in% fuel_solid_vals
      ) %>%
      as_factor(),
    FUELCOOK = as_factor(FUELCOOK)
  )
```

Since we've only loaded the shape file for Colombia so far, for now we will only use the 
data from Colombia. The next step is to summarize by year and geographic unit for the Colombian
censuses. The variable GEOLEV1 contains the geographic units
we want, because we are working with the harmonized geographies in Colombia.
```{r}
colombia_summary <- ipumsi_data %>% 
  filter(COUNTRY == "Colombia") %>%
  group_by(COUNTRY, YEAR, GEOLEV1) %>%
  summarize(pct_solid = mean(SOLIDFUEL == "Solid Fuel", na.rm = TRUE))

colombia_summary
```

Now we're ready to merge the data with the shape data. The functions `ipums_shape_*_join`
help us allign the variable attributes, which are often stored in different formats in
the data compared to the shape file.

```{r}
# Their names aren't identical
names(colombia_summary)
names(colombia_shape)

# GEOLEV1 in the data matches GEOLEVEL1 in the shape file
head(colombia_summary$GEOLEV1)
head(colombia_shape$GEOLEVEL1)

# Also, GEOLEV1 is stored as numeric in data, but GEOLEVEL1 is stored as
# character in the shape file
is.numeric(colombia_summary$GEOLEV1)
is.numeric(colombia_shape$GEOLEVEL1)

# But ipums_shape_right_join takes care of this for us
colombia <- ipums_shape_right_join(
  colombia_summary, 
  colombia_shape,
  by = c("GEOLEV1" = "GEOLEVEL1")
)

colombia
```

Now we are ready to use the data. Here's how we can make a map facetted
by year.
```{r, fig.height = 4, fig.width = 6}
# Note the function `geom_sf()` is a very new function, so you may need to update
# ggplot2 to run.
if ("geom_sf" %in% getNamespaceExports("ggplot2")) {
  ggplot(data = colombia, aes(fill = pct_solid)) +
    geom_sf() + 
    facet_wrap(~YEAR) + 
    scale_fill_continuous("", labels = scales::percent) + 
    labs(
      title = "Percent of Children 0-5 Who Live in a Home That Cooks Using Solid Fuel",
      subtitle = "Colombia Census Data",
      caption = paste0("Source: ", ipums_file_info(ipumsi_ddi)$ipums_project)
    )
}
```

### Combining Multiple Shape Files
Though the IPUMS harmonization allowed us to use the same shape file for
all 3 years of census data from Colombia, if we want to show the data
for Ecuador and Peru also, we need to combine multiple shape files. 

The variable FUELCOOK was only available for a single year in Ecuador
and Peru, so I have chosen to use the non-harmonized version of the
shape files for these two countries.

```{r}
ecuador_shape_file <- system.file("extdata", "geo1_ec2010.zip", package = "ripumsexamples")
ecuador_shape <- read_ipums_sf(ecuador_shape_file, verbose = FALSE)

peru_shape_file <- system.file("extdata", "geo1_pe2007.zip", package = "ripumsexamples")
peru_shape <- read_ipums_sf(peru_shape_file, verbose = FALSE)
```

Because we are no longer using the harmonized geographic variables, the names in our
shape files don't match. In the non-harmonized shape files for IPUMS International,
the variable you will want to join is called "IPUMS{YEAR}", so in our case Ecuador 2010
is IPUM2010 and Peru 2007 is IPUM2007 (and the variable was GEOLEVEL1 in the harmonized
dataset).

We will use the rbind command to combine these datasets, and I strongly recommend
making the variable names and order the same across the different shape files.
So we need to rename the join variable in each, and also, I reduce the dataset
to fewer variables so that there is less chance that a variable is not available
in some years. Note that non-harmonized IDs are not unique, so if you are combining
multiple countries you need to keep a variable indicating what country it is, and 
if you are combining multiple years for the same country, you need to add a year
variable identifying which year it refers to.

```{r}
colombia_shape <- colombia_shape %>%
  select(CNTRY_NAME, ADMIN_NAME, GEOJOINID = GEOLEVEL1, geometry)

ecuador_shape <- ecuador_shape %>%
  select(CNTRY_NAME, ADMIN_NAME, GEOJOINID = IPUM2010, geometry)

peru_shape <- peru_shape %>%
  select(CNTRY_NAME, ADMIN_NAME, GEOJOINID = IPUM2007, geometry)
```

Now that the datasets have the same structure, we are ready to use 
the rbind command.

```{r}
all_shapes <- rbind(colombia_shape, ecuador_shape, peru_shape)
all_shapes$CNTRY_NAME <- as.character(all_shapes$CNTRY_NAME)
```

The geographic variables aren't stored with a consistent name in the
data either. For Colombia, the correct join variable is still GEOLEV1,
but for Ecuador it is GEO1_EC2010 and for Peru it is GEO1_PE2007.
```{r}
ipumsi_data <- ipumsi_data %>%
  mutate(GEOJOINID = case_when(
    COUNTRY == "Colombia" ~ GEOLEV1,
    COUNTRY == "Ecuador" ~ GEO1_EC2010,
    COUNTRY == "Peru" ~ GEO1_PE2007
  ))
```

As before, we summarize the data to the geographic unit, merge it with
the shape data and then map it.
```{r, fig.height = 4, fig.width = 6}
all_summary <- ipumsi_data %>% 
  filter(YEAR > 2004) %>%
  group_by(COUNTRY, GEOJOINID) %>%
  summarize(pct_solid = mean(SOLIDFUEL == "Solid Fuel", na.rm = TRUE))

all <- ipums_shape_right_join(
  all_summary, 
  all_shapes, 
  by = c("COUNTRY" = "CNTRY_NAME", "GEOJOINID")
)

# Note the function `geom_sf()` is a very new function, so you may need to update
# ggplot2 to run.
if ("geom_sf" %in% getNamespaceExports("ggplot2")) {
  ggplot(data = all, aes(fill = pct_solid)) +
    geom_sf() + 
    scale_fill_continuous("", labels = scales::percent) + 
    labs(
      title = "Percent of Children 0-5 Who Live in a Home That Cooks Using Solid Fuel",
      subtitle = "Colombia (2005), Ecuador (2010) and Peru (2007) Census Data",
      caption = paste0("Source: ", ipums_file_info(ipumsi_ddi)$ipums_project)
    )
}
```

## NHGIS
### Loading Data and Shape Files at the Same Time
NHGIS data extracts include options for downloading the shape files specific to
the data you have included in your extract. To get shape files for the boundaries
for NHGIS data, when creating an extract, be sure to include a "GIS Boundary
File", which is one of the tabs under "SELECT DATA". Once you have created the
extract, there will be 2 files to download, one containing the data and another
containing the shape files.

As part of the NHGIS vignette (`vignette("ipums-nhgis")`), we downloaded the data and shape
files about the number of slaves per state in the 1830 census. To load the data and 
boundaries into R, we can run the following command:
```{r}
nhgis_1830_csv_file <- system.file("extdata", "nhgis0010_csv.zip", package = "ripumsexamples")
nhgis_1830_shape_file <- system.file("extdata", "nhgis0010_shape.zip", package = "ripumsexamples")

nhgis_ddi <- read_ipums_codebook(nhgis_1830_csv_file) 
nhgis <- read_nhgis_sf(
  data_file = nhgis_1830_csv_file,
  shape_file = nhgis_1830_shape_file,
  verbose = FALSE
)
```

Now the data and shapes are available for us to run R code on. Here's how we can use
ggplot2 to make a map of the percentage of people enslaved by state.
```{r, fig.height = 4, fig.width = 6}
nhgis <- nhgis %>%
  mutate(pct_slave = (ABO003 + ABO004) / (ABO001 + ABO002 + ABO003 + ABO004 + ABO005 + ABO006))

# Note the function `geom_sf()` is a very new function, so you may need to update
# ggplot2 to run.
if ("geom_sf" %in% getNamespaceExports("ggplot2")) {
  ggplot(data = nhgis, aes(fill = pct_slave)) +
    geom_sf() + 
    scale_fill_continuous("", labels = scales::percent) + 
    labs(
      title = "Percent of Population that was Enslaved by State",
      subtitle = "1830 Census",
      caption = paste0("Source: ", ipums_file_info(nhgis_ddi)$ipums_project)
    )
}
```

TKTKTK - explanation of grey area

Users of the sp geographic data types should know that mapping sp geographic data does 
require different syntax than shown here for sf data. The resources at the bottom of this 
vgnette include more details.

### Loading Data and Shape Files Separately
Even for NHGIS, some analyses require loading the data and shape file 
separately. This process is similar to how the data and shape files were
combined for the microdata projects above. I can't think of a simple
example when this would come up naturally, so I will just use the same 1830
census data from above.

```{r}
# Load just the data
nhgis_data <- read_nhgis(nhgis_1830_csv_file, verbose = FALSE) 

# Load just the shape data
nhgis_shape <- read_ipums_sf(nhgis_1830_shape_file, verbose = FALSE) 
```

Now that we have the data and boundaries loaded into separate objects, the 
`ipums_shape_*_join` functions help join them together. These functions
work in a similar manner to the `*_join` functions in dplyr, but help
get the joining variables into the same structure in the 2 different objects.

```{r}
nhgis <- ipums_shape_full_join(
  nhgis_data, 
  nhgis_shape, 
  by = "GISJOIN" # For NHGIS, both the shape file and data have "GISJOIN" variables
)
```

### Combining Multiple Shape Files
If you are working with block level data across multiple states, our extract engine has
to split them into multiple files because the boundaries for the whole country would be 
too large. The ripums package can handle this atuomatically
if you are loading the data and shape files at the same time. The `read_ipums_sp` 
and `read_ipums_sf` functions will combine multiple shape files for you.

This example includes data from Connecticut and Rhode Island about the median age
per census block from the 2010 census. Note that the detail in the shape files has 
been reduced from the original downloaded files to save space in the ripums repository.
```{r, fig.height = 4, fig.width = 6}
nhgis_block_csv_file <- system.file("extdata", "nhgis0024_csv.zip", package = "ripumsexamples")
nhgis_block_shape_file <- system.file("extdata", "nhgis0024_shape_small.zip", package = "ripumsexamples")

nhgis_ddi <- read_ipums_codebook(nhgis_block_csv_file) 
nhgis <- read_nhgis_sf(
  data_file = nhgis_block_csv_file,
  shape_file = nhgis_block_shape_file,
  verbose = FALSE
)

# The median age is 0 for unpopulated counties, set them to NA
nhgis <- nhgis %>%
  mutate(H77001 = ifelse(H77001 == 0, NA, H77001))

# Filter to Hartford County, CT and Providence County, RI
nhgis_subset <- nhgis %>%
  filter(COUNTY %in% c("Hartford County", "Providence County")) %>%
  mutate(place_name = paste0(COUNTY, ", ", STATE))

if ("geom_sf" %in% getNamespaceExports("ggplot2")) {
  ggplot(data = nhgis_subset, aes(fill = H77001)) +
    geom_sf(linetype = "blank") + 
    scale_fill_continuous("") + 
    facet_wrap(~place_name, scales = "free") + 
    labs(
      title = "Median Age of Population By Census Block",
      subtitle = "2010 Census",
      caption = paste0(
        "Source: ", ipums_file_info(nhgis_ddi)$ipums_project, "\n",
        "Simplified Census Block boundaries (1% of points retained)"
      )
    )
}
```

As mentioned earlier, the details of mapping sp objects are slightly different
than sf. See the additional resources at the end of this vignette.

TKTKTK - explanation of grey area

When combining across years where the geographies have not been harmonized or
across different geographic levels you may also want to work with multiple shape
files. In these situations, the ripums package cannot automatically combine the data
for you. Instead, use the `rbind()` function which has been implemented for sf 
(and sp) objects.

Though the code above showed that this data could be loaded all at once, this
example shows how it could be loaded separately as an example for extracts where
the differnet files can't be loaded at the same time.

```{r}
ipums_list_files(nhgis_block_shape_file)

nhgis_ct <- read_nhgis_sf(
  data_file = nhgis_block_csv_file,
  shape_file = nhgis_block_shape_file,
  shape_layer = contains("090"), # Connecticut's FIPS code that is in the file name
  verbose = FALSE
) %>% 
  filter(STATE == "Connecticut")

nhgis_ri <- read_nhgis_sf(
  data_file = nhgis_block_csv_file,
  shape_file = nhgis_block_shape_file,
  shape_layer = contains("440"), # Rhode Island's FIPS code
  verbose = FALSE
)%>% 
  filter(STATE == "Rhode Island")

nhgis <- rbind(nhgis_ct, nhgis_ri)

nhgis
```

## Troubleshooting Missing Data
TKTKTKTK

## Resources for Geographic Analysis in R
TKTKTK
sf vignettes
ggplot2 with sf blog post?
sp fortify with ggplot2
other sp resources?
sf R consortium proposal
