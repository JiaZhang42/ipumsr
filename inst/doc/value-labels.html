<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Minnesota Population Center" />

<meta name="date" content="2017-09-22" />

<title>Value Labels</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Value Labels</h1>
<h4 class="author"><em>Minnesota Population Center</em></h4>
<h4 class="date"><em>2017-09-22</em></h4>



<div id="value-labels-in-the-ripums-package" class="section level1">
<h1>Value labels in the ripums package</h1>
<p>Integrated variables in IPUMS data often have value labels, which attach text labels to the values taken by a variable (for example 1 = “Excellent”). These values can be incredibly useful during analysis. The <code>ripums</code> package does import the labels, but they can be hard to spot at first:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ripums)
ddi &lt;-<span class="st"> </span><span class="kw">read_ipums_ddi</span>(<span class="kw">ripums_example</span>(<span class="st">&quot;cps_00015.xml&quot;</span>))
cps &lt;-<span class="st"> </span><span class="kw">read_ipums_micro</span>(ddi, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)

cps</code></pre></div>
<pre><code>## # A tibble: 10,883 x 13
##     YEAR SERIAL HWTSUPP  STATEFIP  ASECFLAG     MONTH PERNUM  WTSUPP
##  * &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl+lbl&gt; &lt;dbl+lbl&gt; &lt;dbl+lbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1  2016  24138 3249.07        55         1         3      1 3249.07
##  2  2016  24139 3154.25        55         1         3      1 3154.25
##  3  2016  24139 3154.25        55         1         3      2 3154.25
##  4  2016  24140 1652.37        55         1         3      1 1652.37
##  5  2016  24140 1652.37        55         1         3      2 1502.68
##  6  2016  24140 1652.37        55         1         3      3 1652.37
##  7  2016  24141 3049.23        55         1         3      1 3049.23
##  8  2016  24142 1636.77        55         1         3      1 1636.77
##  9  2016  24142 1636.77        55         1         3      2 1636.77
## 10  2016  24142 1636.77        55         1         3      3 1887.04
## # ... with 10,873 more rows, and 5 more variables: AGE &lt;dbl+lbl&gt;,
## #   EDUC &lt;dbl+lbl&gt;, INCTOT &lt;dbl+lbl&gt;, HEALTH &lt;dbl+lbl&gt;, MIGRATE1 &lt;dbl+lbl&gt;</code></pre>
<p>The first clue that some of the variables are labelled is the <code>&lt;dbl+lbl&gt;</code> that appear below <code>STATEFIP</code>, <code>ASECFLAG</code> and other variables. The tibble package prints the variable’s type information below the variable name. You also can use the <code>is.labelled()</code> function to check if a variable is labelled.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is.labelled</span>(cps$STATEFIP)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sapply</span>(cps, is.labelled)</code></pre></div>
<pre><code>##     YEAR   SERIAL  HWTSUPP STATEFIP ASECFLAG    MONTH   PERNUM   WTSUPP 
##    FALSE    FALSE    FALSE     TRUE     TRUE     TRUE    FALSE    FALSE 
##      AGE     EDUC   INCTOT   HEALTH MIGRATE1 
##     TRUE     TRUE     TRUE     TRUE     TRUE</code></pre>
<p>There are a few options to see what the actual labels are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Printing the variable directly (or a subset)</span>
<span class="kw">head</span>(cps$MONTH)</code></pre></div>
<pre><code>## &lt;Labelled double&gt;
## [1] 3 3 3 3 3 3
## 
## Labels:
##  value     label
##      1   January
##      2  February
##      3     March
##      4     April
##      5       May
##      6      June
##      7      July
##      8    August
##      9 September
##     10   October
##     11  November
##     12  December</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Just get the labels</span>
<span class="kw">ipums_val_labels</span>(cps$MONTH)</code></pre></div>
<pre><code>## # A tibble: 12 x 2
##      val       lbl
##    &lt;dbl&gt;     &lt;chr&gt;
##  1     1   January
##  2     2  February
##  3     3     March
##  4     4     April
##  5     5       May
##  6     6      June
##  7     7      July
##  8     8    August
##  9     9 September
## 10    10   October
## 11    11  November
## 12    12  December</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># or if you're working interactively you can use ipums_view</span>
<span class="co"># ipums_view(ddi)</span></code></pre></div>
</div>
<div id="why-use-the-labelled-class-instead-of-base-rs-factors" class="section level1">
<h1>Why use the labelled class instead of base R’s factors?</h1>
<p>The usual way to connect numeric data to labels in R is in <code>factor</code> variables. Though this data type is more native to R, and more widely supported by R code, it was designed to for efficient calculations in linear models, not as a general purpose value labelling system and so is missing important features that the value labels provided by IPUMS require.</p>
<p>Factors only allow for integers to be mapped to a text label, and these integers have to be a count starting at 1. This doesn’t work for IPUMS data because often we use the numeric values to have meaning that would be lost if converted to factors. The variable <code>AGE</code> uses the value to mean the actual age, but does have value labels indicating what age 0 means and the top codes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(cps$AGE)</code></pre></div>
<pre><code>## &lt;Labelled double&gt;
## [1] 54 54 52 38 15 38
## 
## Labels:
##  value               label
##      0        Under 1 year
##     90 90 (90+, 1988-2002)
##     99                 99+</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cps$AGE_FACTOR &lt;-<span class="st"> </span><span class="kw">as_factor</span>(cps$AGE)
<span class="kw">head</span>(cps$AGE_FACTOR)</code></pre></div>
<pre><code>## [1] 54 54 52 38 15 38
## 84 Levels: Under 1 year 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ... 99+</code></pre>
<p>It may seem like the new <code>AGE_FACTOR</code> variable is okay, but it can be very confusing!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(cps$AGE)</code></pre></div>
<pre><code>## [1] 35.0226</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># mean(cps$AGE_FACTOR) # error because data is a factor not numeric</span>

<span class="kw">mean</span>(<span class="kw">as.numeric</span>(cps$AGE_FACTOR)) <span class="co"># A common mistake</span></code></pre></div>
<pre><code>## [1] 35.94836</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The &quot;more&quot; correct way, but NA because of the text labels</span>
<span class="kw">mean</span>(<span class="kw">as.numeric</span>(<span class="kw">as.character</span>(cps$AGE_FACTOR)))</code></pre></div>
<pre><code>## Warning in mean(as.numeric(as.character(cps$AGE_FACTOR))): NAs introduced
## by coercion</code></pre>
<pre><code>## [1] NA</code></pre>
<p>Because the factor variable has to assign values starting at 1, but the AGE variable started at 0, most values were 1 higher than they should have been. Not all values are 1 higher though, because not all values exist in the data, so 85, 90, and 99 are 82, 83 and 84 respectively.</p>
<p>Factors also require that every value be labelled, which is not always true in IPUMS data. In the AGE variable, the only values with labels are 0, 90 and 99. For all other values, there is not additional label information.</p>
</div>
<div id="is-the-labelled-class-a-panacea-hint-no" class="section level1">
<h1>Is the labelled class a panacea? (Hint: no)</h1>
<p>Though the labelled does express all of the meaning provided by IPUMS value labels into R, many R functions cannot use them or even actively remove them from the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ipums_val_labels</span>(cps$HEALTH)</code></pre></div>
<pre><code>## # A tibble: 5 x 2
##     val       lbl
##   &lt;dbl&gt;     &lt;chr&gt;
## 1     1 Excellent
## 2     2 Very good
## 3     3      Good
## 4     4      Fair
## 5     5      Poor</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">HEALTH2 &lt;-<span class="st"> </span><span class="kw">ifelse</span>(cps$HEALTH &gt;<span class="st"> </span><span class="dv">3</span>, <span class="dv">3</span>, cps$HEALTH)
<span class="kw">ipums_val_labels</span>(HEALTH2)</code></pre></div>
<pre><code>## # A tibble: 0 x 2
## # ... with 2 variables: val &lt;dbl&gt;, lbl &lt;chr&gt;</code></pre>
<p>Therefore, your first task when importing an IPUMS dataset will usually be to convert the labelled values to other data structures. The bad news is that there’s no good automatic way to do this; a lot depends on how you plan to use the variables in your analysis and your preferences.</p>
<p>The good news is that the ripums package provides several functions to make this process easier.</p>
<p>I think it is easiest to learn them by seeing them in action, but here is a list: - <code>as_factor()</code> (really from the haven package) - <code>zap_labels()</code> - <code>lbl_na_if()</code> - <code>lbl_collapse()</code> - <code>lbl_relabel()</code> - <code>lbl_add()</code> - <code>lbl_add_vals()</code></p>
</div>
<div id="workflow-example-using-ripums-functions" class="section level1">
<h1>Workflow example using ripums functions</h1>
<div id="as_factor" class="section level2">
<h2><code>as_factor()</code></h2>
<p>The HEALTH variable is structured just like a factor and so can be converted directly. The <code>as_factor()</code> function is the easiest way to do so.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ipums_val_labels</span>(cps$HEALTH)</code></pre></div>
<pre><code>## # A tibble: 5 x 2
##     val       lbl
##   &lt;dbl&gt;     &lt;chr&gt;
## 1     1 Excellent
## 2     2 Very good
## 3     3      Good
## 4     4      Fair
## 5     5      Poor</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cps$HEALTH &lt;-<span class="st"> </span><span class="kw">as_factor</span>(cps$HEALTH)</code></pre></div>
<p>The ASECFLAG and MONTH variable can also be converted directly (which were included by default by the IPUMS extract engine, but isn’t that useful because this dataset only has respondents from ASEC in March)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cps$ASECFLAG &lt;-<span class="st"> </span><span class="kw">as_factor</span>(cps$ASECFLAG)
cps$MONTH &lt;-<span class="st"> </span><span class="kw">as_factor</span>(cps$MONTH)</code></pre></div>
<p><code>as_factor</code> works on data.frames by converting every labelled variable to a factor. However, this can create confusing variables like AGE_FACTOR from above, so this isn’t the best thing to do right away.</p>
</div>
<div id="zap_labels" class="section level2">
<h2><code>zap_labels()</code></h2>
<p>I may decide that for my analysis, the AGE variable is most useful as the numeric values. The <code>zap_labels()</code> function removes the labels.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cps$AGE &lt;-<span class="st"> </span><span class="kw">zap_labels</span>(cps$AGE)</code></pre></div>
<p>The topcodes (which are only available on the CPS website) indicate that the values 80 actually indicates 80-84 and 85 indicates 85+, so another option would be to convert them to a factor with age ranges.</p>
</div>
<div id="lbl_clean" class="section level2">
<h2><code>lbl_clean()</code></h2>
<p>This extract only contains data from a few states and I don’t want the factor to have a level for the unused ones. The <code>lbl_clean()</code> function keeps only labels for values in the current dataset and returns a labelled variable which we can convert to a factor.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ipums_val_labels</span>(cps$STATEFIP)</code></pre></div>
<pre><code>## # A tibble: 75 x 2
##      val                  lbl
##    &lt;dbl&gt;                &lt;chr&gt;
##  1     1              Alabama
##  2     2               Alaska
##  3     4              Arizona
##  4     5             Arkansas
##  5     6           California
##  6     8             Colorado
##  7     9          Connecticut
##  8    10             Delaware
##  9    11 District of Columbia
## 10    12              Florida
## # ... with 65 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cps$STATEFIP &lt;-<span class="st"> </span><span class="kw">lbl_clean</span>(cps$STATEFIP)

<span class="kw">ipums_val_labels</span>(cps$STATEFIP)</code></pre></div>
<pre><code>## # A tibble: 5 x 2
##     val          lbl
##   &lt;dbl&gt;        &lt;chr&gt;
## 1    19         Iowa
## 2    27    Minnesota
## 3    38 North Dakota
## 4    46 South Dakota
## 5    55    Wisconsin</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cps$STATEFIP &lt;-<span class="st"> </span><span class="kw">as_factor</span>(cps$STATEFIP)</code></pre></div>
</div>
<div id="lbl_na_if" class="section level2">
<h2><code>lbl_na_if()</code></h2>
<p>The INCTOT variable has 2 labelled values that are not actually incomes: 99999998 indicates “Missing” and 99999999 indicate “Not in Universe”. On the CPS website, the Universe tab indicates that the Universe for 2016 is respondents age 15+. Let’s say for my analysis, I can treat these values as missing.</p>
<p>The <code>lbl_na_if()</code> function takes the variable and a function that refers to .val and .lbl (the values and labels respectively) and returns an indicator of whether to set those values to NA and remove the label. You can also use the <code>~</code> notation from the purrr package to create succinct annonymous functions.</p>
<p>The .val and .lbl only refer to values that already have labels, they do not apply to unlabelled values. See the <code>lbl_add()</code> and <code>lbl_add_vals()</code> functions below for working with unlabelled values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ipums_val_labels</span>(cps$INCTOT)</code></pre></div>
<pre><code>## # A tibble: 2 x 2
##     val                       lbl
##   &lt;dbl&gt;                     &lt;chr&gt;
## 1 1e+08                  Missing.
## 2 1e+08 N.I.U. (Not in Universe).</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Caution: R defaults to printing large numbers like 99999999 in rounded </span>
<span class="co"># exponential format (1e+08) but that's not how they are actually stored</span>

<span class="co"># All of these are equivalent</span>
INCTOT1 &lt;-<span class="st"> </span><span class="kw">lbl_na_if</span>(cps$INCTOT, ~.val &gt;=<span class="st"> </span><span class="dv">99999990</span>)
INCTOT2 &lt;-<span class="st"> </span><span class="kw">lbl_na_if</span>(cps$INCTOT, ~.lbl %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Missing.&quot;</span>, <span class="st">&quot;N.I.U. (Not in Universe).&quot;</span>))
INCTOT3 &lt;-<span class="st"> </span><span class="kw">lbl_na_if</span>(cps$INCTOT, function(.val, .lbl) {
  is_missing &lt;-<span class="st"> </span>.val ==<span class="st"> </span><span class="dv">99999998</span>
  is_niu &lt;-<span class="st"> </span>.lbl ==<span class="st"> &quot;N.I.U. (Not in Universe).&quot;</span>
  <span class="kw">return</span>(is_missing |<span class="st"> </span>is_niu)
})
<span class="co"># Because only missing and NIU are labelled, and lbl_na_if ignores unlabelled</span>
<span class="co"># values, this also works:</span>
INCTOT4 &lt;-<span class="st"> </span><span class="kw">lbl_na_if</span>(cps$INCTOT, ~<span class="ot">TRUE</span>) 

<span class="co"># Change to a factor in the original cps data.frame</span>
cps$INCTOT &lt;-<span class="st"> </span><span class="kw">lbl_na_if</span>(cps$INCTOT, ~.val &gt;=<span class="st"> </span><span class="dv">9999990</span>)
cps$INCTOT &lt;-<span class="st"> </span><span class="kw">as_factor</span>(cps$INCTOT)</code></pre></div>
</div>
<div id="lbl_collapse" class="section level2">
<h2><code>lbl_collapse()</code></h2>
<p>The EDUC variable provides an example of a common IPUMS practice of grouping categories together by the starting digits. For example, the value 10 indicates “Grades 1, 2, 3, or 4”, and 11 - “Grade 1”, 12 - “Grade 2”, etc.</p>
<p>Let’s say that I only care about those more general categories provided by the first 2 digits. The <code>lbl_collapse()</code> function allows me to provide a function that takes .val and .lbl and returns the value to assign it to. If that code is already used, then the all of the values assigned to it will get that label, otherwise the label of the smallest value is used. Just like with <code>lbl_na_if()</code>, the purrr-style compact syntax using <code>~</code> functions is supported.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ipums_val_labels</span>(cps$EDUC)</code></pre></div>
<pre><code>## # A tibble: 36 x 2
##      val                  lbl
##    &lt;dbl&gt;                &lt;chr&gt;
##  1     0  NIU or no schooling
##  2     1         NIU or blank
##  3     2    None or preschool
##  4    10 Grades 1, 2, 3, or 4
##  5    11              Grade 1
##  6    12              Grade 2
##  7    13              Grade 3
##  8    14              Grade 4
##  9    20        Grades 5 or 6
## 10    21              Grade 5
## # ... with 26 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># %/% is integer division, which divides by the number but doesn't keep the remainder</span>
cps$EDUC &lt;-<span class="st"> </span><span class="kw">lbl_collapse</span>(cps$EDUC, ~.val %/%<span class="st"> </span><span class="dv">10</span>)

<span class="kw">ipums_val_labels</span>(cps$EDUC)</code></pre></div>
<pre><code>## # A tibble: 14 x 2
##      val                  lbl
##    &lt;dbl&gt;                &lt;chr&gt;
##  1     0  NIU or no schooling
##  2     1 Grades 1, 2, 3, or 4
##  3     2        Grades 5 or 6
##  4     3        Grades 7 or 8
##  5     4              Grade 9
##  6     5             Grade 10
##  7     6             Grade 11
##  8     7             Grade 12
##  9     8    1 year of college
## 10     9   2 years of college
## 11    10   3 years of college
## 12    11   4 years of college
## 13    12  5+ years of college
## 14    99      Missing/Unknown</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cps$EDUC &lt;-<span class="st"> </span><span class="kw">as_factor</span>(cps$EDUC)</code></pre></div>
</div>
<div id="lbl_relabel" class="section level2">
<h2><code>lbl_relabel()</code></h2>
<p>Sometimes you may wish to move the labels into new categories. For example, the categories in MIGRATE1 may not quite map what I want to use in my analysis.</p>
<p>The <code>lbl_relabel()</code> function provides a more flexible way to group existing labelled values into new ones. It takes a two-sided formula, where the left-hand side is a label (defined with the <code>lbl()</code> function) and the right hand side is an expression that can use .val and .lbl to evaluate to a logical indicating which values should be assigned to this label.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ipums_val_labels</span>(cps$MIGRATE1)</code></pre></div>
<pre><code>## # A tibble: 8 x 2
##     val                                  lbl
##   &lt;dbl&gt;                                &lt;chr&gt;
## 1     0                                  NIU
## 2     1                           Same house
## 3     2  Different house, place not reported
## 4     3                  Moved within county
## 5     4 Moved within state, different county
## 6     5                 Moved between states
## 7     6                               Abroad
## 8     9                              Unknown</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cps$MIGRATE1 &lt;-<span class="st"> </span><span class="kw">lbl_relabel</span>(
  cps$MIGRATE1,
  <span class="kw">lbl</span>(<span class="dv">0</span>, <span class="st">&quot;NIU / Missing&quot;</span>) ~<span class="st"> </span>.val %in%<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">9</span>),
  <span class="kw">lbl</span>(<span class="dv">1</span>, <span class="st">&quot;Stayed in state&quot;</span>) ~<span class="st"> </span>.val %in%<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>),
  <span class="kw">lbl</span>(<span class="dv">2</span>, <span class="st">&quot;Moved to new state&quot;</span>) ~<span class="st"> </span>.val ==<span class="st"> </span><span class="dv">5</span>,
  <span class="kw">lbl</span>(<span class="dv">3</span>, <span class="st">&quot;Moved abroad&quot;</span>) ~<span class="st"> </span>.val ==<span class="st"> </span><span class="dv">6</span>
)
cps$MIGRATE1 &lt;-<span class="st"> </span><span class="kw">as_factor</span>(cps$MIGRATE1)</code></pre></div>
</div>
<div id="lbl_add-and-lbl_add_vals" class="section level2">
<h2><code>lbl_add()</code> and <code>lbl_add_vals()</code></h2>
<p>It’s harder to come up with real world examples of when these functions would be useful, but for completion’s sake, these functions allow you to create labels for values that aren’t already labelled.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span>haven::<span class="kw">labelled</span>(
  <span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">105</span>, <span class="dv">990</span>, <span class="dv">999</span>, <span class="dv">230</span>),
  <span class="kw">c</span>(<span class="st">`</span><span class="dt">Unknown</span><span class="st">`</span> =<span class="st"> </span><span class="dv">990</span>, <span class="dt">NIU =</span> <span class="dv">999</span>)
)

<span class="kw">lbl_add</span>(x, <span class="kw">lbl</span>(<span class="dv">100</span>, <span class="st">&quot;$100&quot;</span>), <span class="kw">lbl</span>(<span class="dv">105</span>, <span class="st">&quot;$105&quot;</span>), <span class="kw">lbl</span>(<span class="dv">200</span>, <span class="st">&quot;$200&quot;</span>), <span class="kw">lbl</span>(<span class="dv">230</span>, <span class="st">&quot;$230&quot;</span>))</code></pre></div>
<pre><code>## &lt;Labelled double&gt;
## [1] 100 200 105 990 999 230
## 
## Labels:
##  value   label
##    100    $100
##    105    $105
##    200    $200
##    230    $230
##    990 Unknown
##    999     NIU</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lbl_add_vals</span>(x, ~<span class="kw">paste0</span>(<span class="st">&quot;$&quot;</span>, .))</code></pre></div>
<pre><code>## &lt;Labelled double&gt;
## [1] 100 200 105 990 999 230
## 
## Labels:
##  value   label
##    100    $100
##    105    $105
##    200    $200
##    230    $230
##    990 Unknown
##    999     NIU</code></pre>
</div>
<div id="ready-for-analysis" class="section level2">
<h2>Ready for analysis</h2>
<p>And now, after converting all those labels to factors, I’m ready for analysis! If you think of any other helper functions that would be useful for dealing with labels please let us know by filing an issue on <a href="https://github.com/mnpopcenter/ripums/issues">github</a>.</p>
</div>
</div>
<div id="other-resources" class="section level1">
<h1>Other resources</h1>
<p>The haven package vignette ‘semantics’ has some more details about the motivation and implementation of the labelled class. You can view it by running the command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vignette</span>(<span class="st">&quot;semantics&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;haven&quot;</span>)</code></pre></div>
<p>If the ripums <code>lbl_*</code> functions don’t match your workflow, there also is a package called <a href="http://larmarange.github.io/labelled/articles/intro_labelled.html">labelled</a> which provides other methods for manipulating value labels. It is not installed by ripums, but is available on CRAN via the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;labelled&quot;</span>)</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
