---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

# ripums #
[![Project Status:Work-in-Progress](http://www.repostatus.org/badges/latest/wip.svg)](http://www.repostatus.org/#wip)
[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/ripums)](http://cran.r-project.org/web/packages/ripums) 
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/mnpopcenter/ripums?branch=master&svg=true)](https://ci.appveyor.com/project/mnpopcenter/ripums)

The ripums package helps import IPUMS extracts from the [IPUMS website](https://www.ipums.org) 
into R. This project is early in its development, and so we expect there may be bugs and future
API changes that break code. We hope to post a more stable version on CRAN soon.

The ripums package can be installed by running the following commands:
```{r, eval=FALSE}
if (!require(devtools)) install.packages("devtools")

devtools::install_github("mnpopcenter/ripums")
```

## ripumsexamples ##
Example extracts for the vignettes are too big to fit in the main package, but
are included in the 'ripumsexamples' package, which can be installed using the
following commands:

```{r, eval=FALSE}
devtools::install_github("mnpopcenter/ripums", subdir = "ripumsexamples")
```

## Examples ##
These examples rely on extracts made small enough to fit in the package itself:
```{r}
suppressPackageStartupMessages({
  library(ripums)
  library(haven)
  library(ggplot2) # ggplot2 version > 2.2.1 (development version as of 8/15/2017)
  library(dplyr)
  library(sf)
})
```

### CPS - Hierarchical Data ###
Relies on user downloading the .xml DDI file and the .dat/.dat.gz file (doesn't need to be unzipped).
```{r}
# Use example file included with package:
cps_hier_file <- ripums_example("cps_00010.xml")
ddi <- read_ipums_ddi(cps_hier_file)
data <- read_ipums_micro(ddi)

# Variable description for the month variable
cat(ipums_var_desc(ddi, MONTH))

# Hierarachical data loaded as a list by rectype by default
# Household data
data$H

# Value labels loaded as haven::labelled class
# Convert to factors with `as_factor`
table(as_factor(data$H$MONTH, levels = "both"))
```


### CPS - Rectangular Data ###
Relies on user downloading the .xml DDI file and the .dat/.dat.gz file (doesn't need to be unzipped).
```{r, eval = FALSE}
# Use example file included with package
cps_rect_file <- ripums_example("cps_00006.xml")
data <- read_ipums_micro(cps_rect_file, verbose = FALSE)

# While working interactively, can get convenient display of variable information
# in RStudio's viewer
ipums_view(data)
```

### NHGIS ###
Relies on user downloading the csv file (with or without header row) and shape files (doesn't need to be unzipped).

Note that to save space when including this data on CRAN, the shape file has
been reduced to squares around the centroid of the PMSA. The original
shape file can be found in the `ripumsexamples` package.
```{r}
data <- read_nhgis_sf(
  ripums_example("nhgis0008_csv.zip"),
  shape_file = ripums_example("nhgis0008_shape_small.zip"),
  verbose = FALSE
)

ipums_var_info(data, starts_with("D6Z"))

data <- data %>%
  mutate(
    pct_before_1950 = (D6Z007 + D6Z008) / 
           (D6Z001 + D6Z002 + D6Z003 + D6Z004 + D6Z005 + D6Z006 + D6Z007 + D6Z008)
  )

ggplot(data = data) + 
  geom_sf(aes(fill = pct_before_1950)) + 
  labs(
    title = "Percent of homes built before 1950", 
    subtitle = "By Primary Metropolitan Statistical Area in 1990 Census", 
    caption = "Simplified PMSA boundaries (squares around centroid)"
  )
```

### Terrapop ###
There is experimental support for for loading terrapop data, but examples are too large to include in the package.
```{r, eval=FALSE}
# Raster data
data <- ripums:::read_terra_raster(
  "2552_bundle.zip",
  "CROPLAND2000ZM2013.tiff",
  verbose = FALSE
)

# Area data
data <- ripums:::read_terra_area(
  "2553_bundle.zip",
  verbose = FALSE
)

# Microdata
data <- ripums:::read_terra_micro(
  "2554_bundle.zip",
  verbose = FALSE
)

```
