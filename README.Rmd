---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

# ipumsimport #
The ipumsimport package helps import IPUMS extracts from the [IPUMS website](https://www.ipums.org) 
into R.

It can be installed by running the following commands:
```{r, eval=FALSE}
if (!require(devtools)) install.packages("devtools")

if (Sys.info()$sysname == "Windows") {
  devtools::install_local("Z:/personal/gfellis/ipumsimport")
} else {
  devtools::install_local("/pkg/ipums/personal/gfellis/ipumsimport")
}
```

## Examples ##
```{r}
library(ipumsimport)
library(haven)
library(ggplot2) # ggplot2 version > 2.2.1 (development version as of 8/1/2017)
library(dplyr)

# Can't share extracts in repo, so examples will only work on MPC computers
mpc_root <- function(...) {
  root <- if (Sys.info()[["sysname"]] == "Windows") "//files.pop.umn.edu/ipums/" else "/pkg/ipums/"
  paste0(root, ...)
}

```

### CPS - Hierarchical Data ###
Relies on user downloading the .xml DDI file and the .dat/.dat.gz file (doesn't need to be unzipped).
```{r}
data <- read_ipums_micro(mpc_root("personal/gfellis/ipumsimport_examples/cps_hier/cps_00004.xml"))

cat(ipums_var_desc(data, TCIG100))
table(as_factor(data$TCIG100, levels = "both"))
```


### CPS - Rectangular Data ###
Relies on user downloading the .xml DDI file and the .dat/.dat.gz file (doesn't need to be unzipped).
```{r}
data <- read_ipums_micro(mpc_root("personal/gfellis/ipumsimport_examples/cps_rect/cps_00003.xml"), verbose = FALSE)

cat(ipums_var_desc(data, TCIG100))
table(as_factor(data$TCIG100, levels = "both"))
```

### NHGIS ###
Relies on user downloading the csv file (with or without header row) and shape files (doesn't need to be unzipped).
```{r}
data <- read_nhgis(
  mpc_root("personal/gfellis/ipumsimport_examples/nhgis/nhgis0005_csv.zip"),
  mpc_root("personal/gfellis/ipumsimport_examples/nhgis/nhgis0005_shape.zip"),
  matches("state"),
  verbose = FALSE
)

data <- data %>%
  mutate(pct_slave = (ABO003 + ABO004) / (ABO001 + ABO002 + ABO003 + ABO004 + ABO005 + ABO006))

ggplot(data = data) + 
  geom_sf(aes(fill = pct_slave))
```

Block level census data (Data from Alaska and Arizona)
```{r}
data <- read_nhgis(
  mpc_root("personal/gfellis/ipumsimport_examples/nhgis/nhgis0006_csv.zip"),
  mpc_root("personal/gfellis/ipumsimport_examples/nhgis/nhgis0006_shape.zip")
)

table(data$STATE)
```

### NHGIS - Change over time ### 
Currently tested with the file type "years by column"
```{r}
data <- read_nhgis(
  mpc_root("personal/gfellis/ipumsimport_examples/nhgis/nhgis0007_csv.zip"),
  mpc_root("personal/gfellis/ipumsimport_examples/nhgis/nhgis0007_shape.zip"),
  verbose = FALSE
)

data
```

### Terrapop - Raster Data ###
Relies on zip file from extract (left as-is or unzipped)
```{r}
data <- read_terra_raster(
  mpc_root("personal/gfellis/ipumsimport_examples/terra_raster/2552_bundle.zip"),
  "CROPLAND2000ZM2013.tiff",
  verbose = FALSE
)

raster::plot(data)

# Or can read multiple rasters into a list
data <- read_terra_raster_list(
  mpc_root("personal/gfellis/ipumsimport_examples/terra_raster/2552_bundle.zip"),
  verbose = FALSE
)

names(data) %>% head()

# No variable information provided by extract system though
```

### Terrapop - Area level data ###
Relies on usual extract (with boundary files for maps) either zipped or unzipped
```{r}
data <- read_terra_area(
  mpc_root("personal/gfellis/ipumsimport_examples/terra_area/2553_bundle.zip"),
  verbose = FALSE
)

var_label <- ipums_var_label(data, EDUCTERTIARY_GEO1_BR_BR2010A)
var_label

ggplot(data) +
  geom_sf(aes(fill = EDUCTERTIARY_GEO1_BR_BR2010A)) + 
  scale_fill_continuous("") + 
  ggtitle("Brazil 2010", subtitle = var_label)
```

Can specify which data to use if there are multiple countries in your extract
```{r}
ipums_list_files(mpc_root("personal/gfellis/ipumsimport_examples/terra_area/2644_bundle.zip"))

data <- read_terra_area(
  mpc_root("personal/gfellis/ipumsimport_examples/terra_area/2644_bundle.zip"),
  data_layer = matches("DZ"),
  verbose = FALSE
)

data

```

### Terrapop - Microlevel data ###
Relies on usual extract file (with boundary files for maps) either zipped or unzipped

This file is huge, so won't run on a local machine, but I need IT's help getting some
dependencies set-up to run this on the mpcstats servers.

